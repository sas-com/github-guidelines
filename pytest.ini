# Pytest Configuration for PR Testing
# エス・エー・エス株式会社 - 包括的なPythonテスト設定

[tool:pytest]
# Test discovery
python_files = test_*.py *_test.py tests.py
python_classes = Test* *Tests
python_functions = test_*

# Test paths
testpaths = tests src

# Minimum version
minversion = 7.0

# Addopts - command line options
addopts = 
    # Verbose output
    -v
    # Show extra test summary info
    -ra
    # Show local variables in tracebacks
    --tb=short
    # Coverage reporting
    --cov=src
    --cov-report=html:coverage/html
    --cov-report=xml:coverage/coverage.xml
    --cov-report=term-missing
    --cov-report=json:coverage/coverage.json
    # Coverage thresholds
    --cov-fail-under=80
    # JUnit XML output for CI
    --junitxml=test-results/pytest-results.xml
    # Performance monitoring
    --durations=10
    # Parallel execution (adjust based on available cores)
    -n auto
    # Warnings configuration
    --disable-warnings
    # Color output
    --color=yes
    # Show markers
    --strict-markers
    # Show configuration
    --strict-config

# Coverage configuration
[coverage:run]
source = src
branch = True
omit = 
    */tests/*
    */test_*
    */__init__.py
    */migrations/*
    */venv/*
    */virtualenv/*
    */.venv/*
    */site-packages/*
    */conftest.py
    */setup.py
    */manage.py
    */settings/*
    */wsgi.py
    */asgi.py

[coverage:report]
# Regexes for lines to exclude from consideration
exclude_lines =
    # Have to re-enable the standard pragma
    pragma: no cover
    
    # Don't complain about missing debug-only code:
    def __repr__
    if self\.debug
    
    # Don't complain if tests don't hit defensive assertion code:
    raise AssertionError
    raise NotImplementedError
    
    # Don't complain if non-runnable code isn't run:
    if 0:
    if __name__ == .__main__.:
    
    # Don't complain about abstract methods
    @(abc\.)?abstractmethod

# Coverage thresholds by module
[coverage:html]
directory = coverage/html
title = SAS PR Testing Coverage Report

[coverage:xml]
output = coverage/coverage.xml

[coverage:json]
output = coverage/coverage.json

# Test markers
markers =
    unit: Unit tests
    integration: Integration tests
    security: Security tests
    performance: Performance tests
    slow: Slow tests
    fast: Fast tests
    smoke: Smoke tests
    regression: Regression tests
    api: API tests
    database: Database tests
    external: Tests that require external services
    critical: Critical functionality tests
    
# Pytest plugins
required_plugins =
    pytest-cov>=4.1.0
    pytest-xdist>=3.0.0
    pytest-html>=3.1.0
    pytest-mock>=3.10.0
    pytest-asyncio>=0.21.0
    pytest-benchmark>=4.0.0
    pytest-randomly>=3.12.0
    pytest-timeout>=2.1.0

# Logging configuration
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(name)s: %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# Timeout configuration
timeout = 300
timeout_method = thread

# Async configuration
asyncio_mode = auto

# Test order randomization
randomly-seed = 42
randomly-dont-reset-seed = true

# Benchmark configuration
benchmark_only = false
benchmark_sort = mean
benchmark_compare_fail = mean:5%
benchmark_min_rounds = 5

# Custom options for different test types
[pytest.security]
addopts = 
    --cov-fail-under=95
    --timeout=60

[pytest.performance]
addopts = 
    --benchmark-enable
    --benchmark-sort=mean
    --timeout=300

# Filter warnings
filterwarnings =
    ignore::UserWarning
    ignore::DeprecationWarning:django.*
    ignore::PendingDeprecationWarning
    error::FutureWarning
    
# Django settings (if applicable)
DJANGO_SETTINGS_MODULE = tests.settings
django_find_project = false

# Database configuration for tests
[pytest.database]
addopts = --reuse-db --nomigrations

# Environment variables for testing
env = 
    ENVIRONMENT = test
    DEBUG = False
    SECRET_KEY = test-secret-key-not-for-production
    DATABASE_URL = sqlite:///:memory:
    REDIS_URL = redis://localhost:6379/1
    CELERY_ALWAYS_EAGER = True
    CELERY_BROKER_URL = memory://
    EMAIL_BACKEND = django.core.mail.backends.locmem.EmailBackend