name: PR Security Deep Scan

on:
  pull_request:
    branches: [ main, develop, staging ]
  schedule:
    - cron: '0 2 * * *'  # æ¯æ—¥2æ™‚ã«å®Ÿè¡Œ
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  security-events: write
  actions: read

env:
  SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

jobs:
  # ========================================
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šåˆ†æ
  # ========================================
  security-config-analysis:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šåˆ†æ
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
        run: |
          echo "ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼é–‹å§‹"
          
          # HTTPSå¼·åˆ¶è¨­å®šã®ç¢ºèª
          if find . -name "*.js" -o -name "*.ts" -o -name "*.json" | xargs grep -l "https" > /dev/null; then
            echo "âœ… HTTPSè¨­å®šãŒç¢ºèªã•ã‚Œã¾ã—ãŸ"
          else
            echo "âš ï¸  HTTPSè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          # CORSè¨­å®šã®ç¢ºèª
          if find . -name "*.js" -o -name "*.ts" | xargs grep -l "cors\|CORS" > /dev/null; then
            echo "â„¹ï¸  CORSè¨­å®šãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ - æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦"
          fi
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šã®ç¢ºèª
          SECURITY_HEADERS=("Content-Security-Policy" "X-Frame-Options" "X-Content-Type-Options" "Strict-Transport-Security")
          for header in "${SECURITY_HEADERS[@]}"; do
            if find . -name "*.js" -o -name "*.ts" -o -name "*.json" | xargs grep -l "$header" > /dev/null; then
              echo "âœ… $header ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
            else
              echo "âš ï¸  $header ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            fi
          done

      - name: ç’°å¢ƒå¤‰æ•°ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œè¨¼
        run: |
          echo "ğŸ” ç’°å¢ƒå¤‰æ•°ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œè¨¼é–‹å§‹"
          
          # .envãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f ".env" ]; then
            echo "âŒ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™ - å‰Šé™¤ã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          # ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œç´¢
          PATTERNS=(
            "password\s*=\s*['\"][^'\"]*['\"]"
            "api[_-]?key\s*=\s*['\"][^'\"]*['\"]"
            "secret\s*=\s*['\"][^'\"]*['\"]"
            "token\s*=\s*['\"][^'\"]*['\"]"
          )
          
          for pattern in "${PATTERNS[@]}"; do
            if grep -r -i -E "$pattern" --include="*.js" --include="*.ts" --include="*.py" .; then
              echo "âŒ ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: $pattern"
            fi
          done

      - name: å…¥åŠ›æ¤œè¨¼ãƒ‘ã‚¿ãƒ¼ãƒ³ç¢ºèª
        run: |
          echo "ğŸ›¡ï¸ å…¥åŠ›æ¤œè¨¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç¢ºèª"
          
          # SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ç¢ºèª
          if find . -name "*.js" -o -name "*.ts" -o -name "*.py" | xargs grep -l "prepared\|parameterized\|bind\|placeholder" > /dev/null; then
            echo "âœ… ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã®ä½¿ç”¨ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ"
          else
            echo "âš ï¸  ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã®ä½¿ç”¨ãŒç¢ºèªã§ãã¾ã›ã‚“"
          fi
          
          # XSSå¯¾ç­–ç¢ºèª
          if find . -name "*.js" -o -name "*.ts" | xargs grep -l "escape\|sanitize\|DOMPurify" > /dev/null; then
            echo "âœ… XSSå¯¾ç­–ã®å®Ÿè£…ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ"
          else
            echo "âš ï¸  XSSå¯¾ç­–ã®å®Ÿè£…ãŒç¢ºèªã§ãã¾ã›ã‚“"
          fi

  # ========================================
  # é«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  # ========================================
  advanced-security-scan:
    name: é«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: GitLeaks - ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Semgrep - é«˜åº¦ãªSASTã‚¹ã‚­ãƒ£ãƒ³
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
            p/javascript
            p/typescript
            p/python
            p/java
            p/go
            p/dockerfile
            p/kubernetes
            r/javascript.lang.security.audit
            r/typescript.lang.security.audit
            r/python.lang.security.audit
        env:
          SEMGREP_APP_TOKEN: ${{ env.SEMGREP_APP_TOKEN }}

      - name: Bandit - Python ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
        if: contains(github.event.pull_request.changed_files, '.py')
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . || echo "âš ï¸ Python ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"

      - name: ESLint Security - JavaScript/TypeScript
        if: contains(github.event.pull_request.changed_files, '.js') || contains(github.event.pull_request.changed_files, '.ts')
        run: |
          npm install eslint-plugin-security eslint-plugin-no-secrets
          npx eslint --ext .js,.ts . --plugin security --plugin no-secrets || echo "âš ï¸ JavaScript/TypeScript ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"

      - name: Checkov - IaC ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
        if: contains(github.event.pull_request.changed_files, '.yml') || contains(github.event.pull_request.changed_files, '.yaml')
        run: |
          pip install checkov
          checkov -f . --framework github_actions --framework kubernetes --framework dockerfile || echo "âš ï¸ IaC ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"

  # ========================================
  # ä¾å­˜é–¢ä¿‚è„†å¼±æ€§è©³ç´°ã‚¹ã‚­ãƒ£ãƒ³
  # ========================================
  dependency-security-scan:
    name: ä¾å­˜é–¢ä¿‚è„†å¼±æ€§è©³ç´°ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    strategy:
      matrix:
        scanner: [npm-audit, snyk, safety]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: matrix.scanner == 'npm-audit' || matrix.scanner == 'snyk'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        if: matrix.scanner == 'safety'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: NPM Audit - è©³ç´°ã‚¹ã‚­ãƒ£ãƒ³
        if: matrix.scanner == 'npm-audit'
        run: |
          if [ -f "package.json" ]; then
            npm ci
            npm audit --audit-level=moderate --json > npm-audit.json || true
            npm audit --audit-level=moderate || echo "âš ï¸ NPMè„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            
            # è‡ªå‹•ä¿®æ­£å¯èƒ½ãªè„†å¼±æ€§ã®ä¿®æ­£ææ¡ˆ
            npm audit fix --dry-run || echo "â„¹ï¸ è‡ªå‹•ä¿®æ­£å¯èƒ½ãªè„†å¼±æ€§ãŒã‚ã‚Šã¾ã™"
          fi

      - name: Snyk - åŒ…æ‹¬çš„è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
        if: matrix.scanner == 'snyk'
        run: |
          if [ -f "package.json" ] && [ -n "${{ env.SNYK_TOKEN }}" ]; then
            npm install -g snyk
            snyk auth ${{ env.SNYK_TOKEN }}
            snyk test --json > snyk-report.json || true
            snyk test --severity-threshold=high || echo "âš ï¸ é«˜é‡è¦åº¦ã®è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          fi

      - name: Safety - Python ä¾å­˜é–¢ä¿‚ã‚¹ã‚­ãƒ£ãƒ³
        if: matrix.scanner == 'safety'
        run: |
          if [ -f "requirements.txt" ]; then
            pip install safety
            pip install -r requirements.txt
            safety check --json > safety-report.json || true
            safety check || echo "âš ï¸ Pythonä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          fi

      - name: Upload Scan Results
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-${{ matrix.scanner }}
          path: |
            *-report.json
            *-audit.json

  # ========================================
  # ã‚³ãƒ³ãƒ†ãƒŠã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  # ========================================
  container-security-scan:
    name: ã‚³ãƒ³ãƒ†ãƒŠã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: contains(github.event.pull_request.changed_files, 'Dockerfile') || contains(github.event.pull_request.changed_files, 'docker-compose')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Hadolint - Dockerfile ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°
        run: |
          docker run --rm -i hadolint/hadolint < Dockerfile > hadolint-report.txt || true
          cat hadolint-report.txt

      - name: Build Docker Image
        run: |
          docker build -t security-test-image .

      - name: Trivy - ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
        run: |
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            -v $(pwd):/workspace \
            aquasec/trivy:latest image \
            --format json --output /workspace/trivy-report.json security-test-image || true
          
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            -v $(pwd):/workspace \
            aquasec/trivy:latest image \
            --severity HIGH,CRITICAL security-test-image || echo "âš ï¸ ã‚³ãƒ³ãƒ†ãƒŠã«é«˜é‡è¦åº¦è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"

      - name: Docker Bench Security
        run: |
          docker run --rm -it --net host --pid host --userns host --cap-add audit_control \
            -e DOCKER_CONTENT_TRUST=$DOCKER_CONTENT_TRUST \
            -v /etc:/etc:ro \
            -v /usr/bin/docker-containerd:/usr/bin/docker-containerd:ro \
            -v /usr/bin/docker-runc:/usr/bin/docker-runc:ro \
            -v /usr/lib/systemd:/usr/lib/systemd:ro \
            -v /var/lib:/var/lib:ro \
            -v /var/run/docker.sock:/var/run/docker.sock:ro \
            docker/docker-bench-security > docker-bench-report.txt || true
          cat docker-bench-report.txt

      - name: Upload Container Scan Results
        uses: actions/upload-artifact@v3
        with:
          name: container-security-scan
          path: |
            hadolint-report.txt
            trivy-report.json
            docker-bench-report.txt

  # ========================================
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  # ========================================
  security-report:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    runs-on: ubuntu-latest
    needs: [security-config-analysis, advanced-security-scan, dependency-security-scan, container-security-scan]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v3
        with:
          path: ./security-artifacts

      - name: Generate Security Report
        run: |
          cat > security-report.md << 'EOF'
          # ğŸ”’ PRã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ

          ## ğŸ“Š ã‚¹ã‚­ãƒ£ãƒ³æ¦‚è¦
          - **å®Ÿè¡Œæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          - **PRç•ªå·**: #${{ github.event.number }}
          - **å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.head_ref }}

          ## ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯çµæœ

          ### åŸºæœ¬ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šåˆ†æ: ${{ needs.security-config-analysis.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}
          - ç’°å¢ƒå¤‰æ•°ãƒ»ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ: ${{ needs.security-config-analysis.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}
          - å…¥åŠ›æ¤œè¨¼ãƒ‘ã‚¿ãƒ¼ãƒ³: ${{ needs.security-config-analysis.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}

          ### é«˜åº¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
          - GitLeaks (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º): ${{ needs.advanced-security-scan.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}
          - Semgrep (SAST): ${{ needs.advanced-security-scan.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}
          - è¨€èªåˆ¥ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.advanced-security-scan.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }}

          ### ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
          - NPM Audit: ${{ needs.dependency-security-scan.result == 'success' && 'âœ… PASS' || needs.dependency-security-scan.result == 'skipped' && 'â­ï¸ SKIP' || 'âŒ FAIL' }}
          - Snyk ã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.dependency-security-scan.result == 'success' && 'âœ… PASS' || needs.dependency-security-scan.result == 'skipped' && 'â­ï¸ SKIP' || 'âŒ FAIL' }}
          - Safety (Python): ${{ needs.dependency-security-scan.result == 'success' && 'âœ… PASS' || needs.dependency-security-scan.result == 'skipped' && 'â­ï¸ SKIP' || 'âŒ FAIL' }}

          ### ã‚³ãƒ³ãƒ†ãƒŠã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
          - Hadolint (Dockerfile): ${{ needs.container-security-scan.result == 'success' && 'âœ… PASS' || needs.container-security-scan.result == 'skipped' && 'â­ï¸ SKIP' || 'âŒ FAIL' }}
          - Trivy (ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³): ${{ needs.container-security-scan.result == 'success' && 'âœ… PASS' || needs.container-security-scan.result == 'skipped' && 'â­ï¸ SKIP' || 'âŒ FAIL' }}
          - Docker Bench: ${{ needs.container-security-scan.result == 'success' && 'âœ… PASS' || needs.container-security-scan.result == 'skipped' && 'â­ï¸ SKIP' || 'âŒ FAIL' }}

          ## ğŸš¨ Critical Issues
          ${{ needs.security-config-analysis.result == 'failure' && '- âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã«é‡å¤§ãªå•é¡ŒãŒã‚ã‚Šã¾ã™' || '' }}
          ${{ needs.advanced-security-scan.result == 'failure' && '- âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ' || '' }}
          ${{ needs.dependency-security-scan.result == 'failure' && '- âŒ ä¾å­˜é–¢ä¿‚ã«é«˜é‡è¦åº¦ã®è„†å¼±æ€§ãŒã‚ã‚Šã¾ã™' || '' }}
          ${{ needs.container-security-scan.result == 'failure' && '- âŒ ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã«é‡å¤§ãªè„†å¼±æ€§ãŒã‚ã‚Šã¾ã™' || '' }}

          ## ğŸ“‹ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

          ### å³åº§ã«å¯¾å¿œãŒå¿…è¦ (Critical/High)
          - ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å³åº§ã«å‰Šé™¤
          - SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è„†å¼±æ€§ãŒã‚ã‚‹å ´åˆã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã«å¤‰æ›´
          - XSSè„†å¼±æ€§ãŒã‚ã‚‹å ´åˆã¯é©åˆ‡ãªã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ã‚’è¿½åŠ 
          - é«˜é‡è¦åº¦ã®ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã¯æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°

          ### æ”¹å–„æ¨å¥¨ (Medium/Low)
          - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¿½åŠ 
          - HTTPSå¼·åˆ¶è¨­å®šã®ç¢ºèª
          - ãƒ­ã‚°å‡ºåŠ›ã‹ã‚‰ã®æ©Ÿå¯†æƒ…å ±é™¤å»
          - å…¥åŠ›æ¤œè¨¼ã®å¼·åŒ–

          ## ğŸ“š å‚è€ƒè³‡æ–™
          - [OWASP Top 10 2021](https://owasp.org/Top10/)
          - [PRã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ](./PR_SECURITY_CHECKLIST.md)
          - [ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰](./SECURE_CODING_GUIDE.md)

          ## ğŸ” è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
          è©³ç´°ãªã‚¹ã‚­ãƒ£ãƒ³çµæœã¯Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ï¼š
          - security-scan-npm-audit
          - security-scan-snyk
          - security-scan-safety
          - container-security-scan

          ---
          ğŸ¤– ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã«ã¤ã„ã¦ã¯å¿…ãšæ‰‹å‹•ã§ã‚‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚
          EOF

      - name: PR Comment with Security Report
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const securityReport = fs.readFileSync('security-report.md', 'utf8');
            
            // æ—¢å­˜ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const existingComment = comments.data.find(comment => 
              comment.body.includes('ğŸ”’ PRã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ')
            );
            
            if (existingComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: securityReport
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: securityReport
              });
            }

      - name: Security Status Check
        run: |
          if [[ "${{ needs.security-config-analysis.result }}" == "failure" || 
                "${{ needs.advanced-security-scan.result }}" == "failure" || 
                "${{ needs.dependency-security-scan.result }}" == "failure" || 
                "${{ needs.container-security-scan.result }}" == "failure" ]]; then
            echo "âŒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã§é‡å¤§ãªå•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "è©³ç´°ã¯ç”Ÿæˆã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          else
            echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
          fi