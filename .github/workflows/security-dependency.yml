name: Dependency Security Scanning

on:
  push:
    paths:
      - 'package*.json'
      - 'requirements*.txt'
      - 'go.mod'
      - 'pom.xml'
      - 'Gemfile*'
      - '.github/workflows/security-dependency.yml'
  pull_request:
    paths:
      - 'package*.json'
      - 'requirements*.txt'
      - 'go.mod'
      - 'pom.xml'
      - 'Gemfile*'
  schedule:
    - cron: '0 9 * * 1'  # ÊØéÈÄ±ÊúàÊõúÊó• 9:00 JST

permissions:
  contents: read
  security-events: write
  issues: write
  pull-requests: write

jobs:
  # ===== Dependency Analysis =====
  dependency-analysis:
    name: Dependency Security Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Detect Package Managers
      id: detect
      run: |
        echo "Detecting package managers..."
        
        # Initialize detection flags
        echo "npm=false" >> $GITHUB_OUTPUT
        echo "pip=false" >> $GITHUB_OUTPUT
        echo "go=false" >> $GITHUB_OUTPUT
        echo "maven=false" >> $GITHUB_OUTPUT
        echo "bundler=false" >> $GITHUB_OUTPUT
        echo "docker=false" >> $GITHUB_OUTPUT
        
        # Check for package managers
        [ -f "package.json" ] && echo "npm=true" >> $GITHUB_OUTPUT
        [ -f "requirements.txt" ] || [ -f "requirements-dev.txt" ] && echo "pip=true" >> $GITHUB_OUTPUT
        [ -f "go.mod" ] && echo "go=true" >> $GITHUB_OUTPUT
        [ -f "pom.xml" ] && echo "maven=true" >> $GITHUB_OUTPUT
        [ -f "Gemfile" ] && echo "bundler=true" >> $GITHUB_OUTPUT
        [ -f "Dockerfile" ] && echo "docker=true" >> $GITHUB_OUTPUT

  # ===== NPM/Node.js Dependencies =====
  npm-security:
    name: NPM Security Audit
    runs-on: ubuntu-latest
    needs: dependency-analysis
    if: needs.dependency-analysis.outputs.npm == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install Dependencies
      run: npm ci
      
    - name: NPM Audit
      run: |
        echo "## NPM Audit Report" > npm-audit-report.md
        echo "" >> npm-audit-report.md
        
        # Run npm audit and capture output
        npm audit --json > npm-audit.json || true
        
        # Parse and format results
        node << 'EOF'
        const fs = require('fs');
        const audit = JSON.parse(fs.readFileSync('npm-audit.json', 'utf8'));
        
        let report = '';
        let criticalCount = 0;
        let highCount = 0;
        let moderateCount = 0;
        let lowCount = 0;
        
        if (audit.metadata) {
          criticalCount = audit.metadata.vulnerabilities.critical || 0;
          highCount = audit.metadata.vulnerabilities.high || 0;
          moderateCount = audit.metadata.vulnerabilities.moderate || 0;
          lowCount = audit.metadata.vulnerabilities.low || 0;
          
          report += `### Summary\n\n`;
          report += `| Severity | Count |\n`;
          report += `|----------|-------|\n`;
          report += `| Critical | ${criticalCount} |\n`;
          report += `| High | ${highCount} |\n`;
          report += `| Moderate | ${moderateCount} |\n`;
          report += `| Low | ${lowCount} |\n\n`;
        }
        
        if (audit.vulnerabilities) {
          report += `### Vulnerabilities\n\n`;
          
          Object.entries(audit.vulnerabilities).forEach(([name, vuln]) => {
            report += `#### ${name}\n`;
            report += `- **Severity**: ${vuln.severity}\n`;
            report += `- **Via**: ${vuln.via.map(v => typeof v === 'string' ? v : v.title).join(', ')}\n`;
            report += `- **Range**: ${vuln.range}\n`;
            report += `- **Fix Available**: ${vuln.fixAvailable ? 'Yes' : 'No'}\n\n`;
          });
        }
        
        fs.appendFileSync('npm-audit-report.md', report);
        
        // Exit with error if critical or high vulnerabilities
        if (criticalCount > 0 || highCount > 0) {
          console.error(`Found ${criticalCount} critical and ${highCount} high vulnerabilities`);
          process.exit(1);
        }
        EOF
        
    - name: NPM Audit Fix
      run: |
        npm audit fix --force || true
        
    - name: Snyk Security Scan
      if: env.SNYK_TOKEN != ''
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      run: |
        npm install -g snyk
        snyk test --severity-threshold=high --json > snyk-npm-report.json || true
        snyk monitor || true
        
    - name: RetireJS Scan
      run: |
        npm install -g retire
        retire --outputformat json --outputpath retire-report.json || true
        
    - name: License Compliance Check
      run: |
        npm install -g license-checker
        
        # Check for problematic licenses
        license-checker --json > licenses.json
        
        node << 'EOF'
        const fs = require('fs');
        const licenses = JSON.parse(fs.readFileSync('licenses.json', 'utf8'));
        
        const problematicLicenses = ['GPL-3.0', 'AGPL-3.0', 'LGPL-3.0'];
        const violations = [];
        
        Object.entries(licenses).forEach(([pkg, info]) => {
          if (problematicLicenses.some(lic => info.licenses && info.licenses.includes(lic))) {
            violations.push({
              package: pkg,
              license: info.licenses
            });
          }
        });
        
        if (violations.length > 0) {
          console.error('License compliance violations found:');
          console.error(JSON.stringify(violations, null, 2));
          process.exit(1);
        }
        
        console.log('‚úÖ License compliance check passed');
        EOF
        
    - name: Upload NPM Security Results
      uses: actions/upload-artifact@v4
      with:
        name: npm-security-results
        path: |
          npm-audit.json
          npm-audit-report.md
          snyk-npm-report.json
          retire-report.json
          licenses.json
        retention-days: 30

  # ===== Python Dependencies =====
  python-security:
    name: Python Security Audit
    runs-on: ubuntu-latest
    needs: dependency-analysis
    if: needs.dependency-analysis.outputs.pip == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install Dependencies
      run: |
        pip install -r requirements.txt || true
        pip install safety pip-audit bandit
        
    - name: Safety Check
      run: |
        safety check --json > safety-report.json || true
        
        # Generate markdown report
        python3 << 'EOF'
        import json
        
        with open('safety-report.json', 'r') as f:
            data = json.load(f)
        
        report = "## Python Safety Check\n\n"
        
        if isinstance(data, list) and len(data) > 0:
            report += "### Vulnerabilities Found\n\n"
            
            for vuln in data:
                report += f"#### {vuln.get('package', 'Unknown')}\n"
                report += f"- **Installed Version**: {vuln.get('installed_version', 'Unknown')}\n"
                report += f"- **Affected Versions**: {vuln.get('affected_versions', 'Unknown')}\n"
                report += f"- **Description**: {vuln.get('description', 'No description')}\n"
                report += f"- **CVE**: {vuln.get('cve', 'N/A')}\n\n"
        else:
            report += "‚úÖ No vulnerabilities found\n"
        
        with open('safety-report.md', 'w') as f:
            f.write(report)
        EOF
        
    - name: Pip Audit
      run: |
        pip-audit --format json --output pip-audit-report.json || true
        
    - name: Bandit Security Scan
      run: |
        bandit -r . -f json -o bandit-dependency-report.json \
          --severity-level medium --confidence-level medium || true
          
    - name: License Check
      run: |
        pip install pip-licenses
        pip-licenses --format=json --with-license-file > python-licenses.json
        
        # Check for problematic licenses
        python3 << 'EOF'
        import json
        
        with open('python-licenses.json', 'r') as f:
            licenses = json.load(f)
        
        problematic = ['GPL-3.0', 'AGPL-3.0']
        violations = []
        
        for pkg in licenses:
            if any(lic in pkg.get('License', '') for lic in problematic):
                violations.append({
                    'package': pkg.get('Name'),
                    'license': pkg.get('License')
                })
        
        if violations:
            print('‚ùå License violations found:')
            print(json.dumps(violations, indent=2))
            exit(1)
        
        print('‚úÖ License check passed')
        EOF
        
    - name: Upload Python Security Results
      uses: actions/upload-artifact@v4
      with:
        name: python-security-results
        path: |
          safety-report.json
          safety-report.md
          pip-audit-report.json
          bandit-dependency-report.json
          python-licenses.json
        retention-days: 30

  # ===== Go Dependencies =====
  go-security:
    name: Go Security Audit
    runs-on: ubuntu-latest
    needs: dependency-analysis
    if: needs.dependency-analysis.outputs.go == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: true
        
    - name: Go Vulnerability Check
      run: |
        go install golang.org/x/vuln/cmd/govulncheck@latest
        govulncheck -json ./... > govuln-report.json || true
        
    - name: Nancy Dependency Check
      run: |
        go list -json -m all | docker run --rm -i sonatypecorp/nancy:latest sleuth \
          -output json > nancy-go-report.json || true
          
    - name: Go License Check
      run: |
        go install github.com/google/go-licenses@latest
        go-licenses check ./... || true
        
    - name: Upload Go Security Results
      uses: actions/upload-artifact@v4
      with:
        name: go-security-results
        path: |
          govuln-report.json
          nancy-go-report.json
        retention-days: 30

  # ===== Java/Maven Dependencies =====
  maven-security:
    name: Maven Security Audit
    runs-on: ubuntu-latest
    needs: dependency-analysis
    if: needs.dependency-analysis.outputs.maven == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: OWASP Dependency Check
      run: |
        mvn org.owasp:dependency-check-maven:8.4.3:check \
          -Dformat=ALL \
          -DfailBuildOnCVSS=7 \
          -DsuppressionFiles=.owasp-suppressions.xml || true
          
    - name: Upload Maven Security Results
      uses: actions/upload-artifact@v4
      with:
        name: maven-security-results
        path: target/dependency-check-report.*
        retention-days: 30

  # ===== Container/Docker Dependencies =====
  container-dependencies:
    name: Container Dependency Scan
    runs-on: ubuntu-latest
    needs: dependency-analysis
    if: needs.dependency-analysis.outputs.docker == 'true'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Build Container Image
      run: |
        docker build -t dependency-scan:${{ github.sha }} .
        
    - name: Trivy Vulnerability Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: dependency-scan:${{ github.sha }}
        format: 'json'
        output: 'trivy-dependencies.json'
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH,MEDIUM'
        
    - name: Grype Vulnerability Scan
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
        grype dependency-scan:${{ github.sha }} -o json > grype-dependencies.json
        
    - name: Syft SBOM Generation
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
        syft dependency-scan:${{ github.sha }} -o json > sbom.json
        syft dependency-scan:${{ github.sha }} -o spdx > sbom.spdx
        syft dependency-scan:${{ github.sha }} -o cyclonedx > sbom.cyclonedx.xml
        
    - name: Upload Container Dependency Results
      uses: actions/upload-artifact@v4
      with:
        name: container-dependency-results
        path: |
          trivy-dependencies.json
          grype-dependencies.json
          sbom.json
          sbom.spdx
          sbom.cyclonedx.xml
        retention-days: 30

  # ===== Dependency Update Automation =====
  dependency-update:
    name: Automated Dependency Updates
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Update NPM Dependencies
      if: hashFiles('package.json')
      run: |
        # Update dependencies
        npx npm-check-updates -u --target minor
        npm install
        npm audit fix
        
        # Check if there are changes
        if git diff --exit-code package*.json; then
          echo "No NPM updates available"
        else
          echo "NPM_UPDATES=true" >> $GITHUB_ENV
        fi
        
    - name: Update Python Dependencies
      if: hashFiles('requirements.txt')
      run: |
        pip install pip-upgrader
        pip-upgrade requirements.txt
        
        if git diff --exit-code requirements.txt; then
          echo "No Python updates available"
        else
          echo "PYTHON_UPDATES=true" >> $GITHUB_ENV
        fi
        
    - name: Create Pull Request
      if: env.NPM_UPDATES == 'true' || env.PYTHON_UPDATES == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore(deps): Update dependencies'
        title: 'üîí Automated Dependency Updates'
        body: |
          ## Automated Dependency Updates
          
          This PR contains automated dependency updates based on security scans.
          
          ### Changes
          - Updated NPM dependencies (if applicable)
          - Updated Python dependencies (if applicable)
          - Applied security fixes
          
          ### Security Scan Results
          - All critical and high vulnerabilities addressed
          - License compliance verified
          
          Please review and merge if all checks pass.
        branch: deps/automated-update-${{ github.run_number }}
        labels: |
          dependencies
          security
          automated

  # ===== Generate Dependency Report =====
  generate-report:
    name: Generate Dependency Security Report
    runs-on: ubuntu-latest
    needs: [npm-security, python-security, go-security, maven-security, container-dependencies]
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: dependency-artifacts
        
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Generate Consolidated Report
      run: |
        cat > generate_dependency_report.py << 'EOF'
        import json
        import os
        from datetime import datetime
        from pathlib import Path
        
        def generate_dependency_report():
            report = {
                "timestamp": datetime.now().isoformat(),
                "scan_type": "Dependency Security",
                "repository": os.environ.get("GITHUB_REPOSITORY", "unknown"),
                "vulnerabilities": {
                    "critical": 0,
                    "high": 0,
                    "medium": 0,
                    "low": 0
                },
                "package_managers": [],
                "license_violations": [],
                "outdated_packages": [],
                "total_dependencies": 0
            }
            
            artifacts_dir = Path("dependency-artifacts")
            
            # Process NPM results
            npm_audit = artifacts_dir / "npm-security-results" / "npm-audit.json"
            if npm_audit.exists():
                with open(npm_audit, 'r') as f:
                    data = json.load(f)
                    if 'metadata' in data:
                        vulns = data['metadata'].get('vulnerabilities', {})
                        report["vulnerabilities"]["critical"] += vulns.get('critical', 0)
                        report["vulnerabilities"]["high"] += vulns.get('high', 0)
                        report["vulnerabilities"]["medium"] += vulns.get('moderate', 0)
                        report["vulnerabilities"]["low"] += vulns.get('low', 0)
                        report["package_managers"].append("npm")
                        report["total_dependencies"] += data['metadata'].get('dependencies', 0)
            
            # Process Python results
            safety_report = artifacts_dir / "python-security-results" / "safety-report.json"
            if safety_report.exists():
                with open(safety_report, 'r') as f:
                    data = json.load(f)
                    if isinstance(data, list):
                        for vuln in data:
                            # Categorize by severity (Safety doesn't provide severity levels)
                            report["vulnerabilities"]["high"] += 1
                        report["package_managers"].append("pip")
            
            # Generate HTML report
            html_template = """
            <!DOCTYPE html>
            <html>
            <head>
                <title>Dependency Security Report</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 40px; }
                    .header { background: #28a745; color: white; padding: 20px; }
                    .summary { background: #f8f9fa; padding: 20px; margin: 20px 0; }
                    .critical { color: #dc3545; font-weight: bold; }
                    .high { color: #fd7e14; font-weight: bold; }
                    .medium { color: #ffc107; }
                    .low { color: #28a745; }
                    .metric { display: inline-block; margin: 20px; padding: 20px; background: white; border: 1px solid #ddd; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Dependency Security Assessment</h1>
                    <p>Repository: {{ repository }}</p>
                    <p>Date: {{ date }}</p>
                </div>
                
                <div class="summary">
                    <h2>Summary</h2>
                    <div class="metric">
                        <h3>Total Dependencies</h3>
                        <p style="font-size: 2em;">{{ total_dependencies }}</p>
                    </div>
                    <div class="metric">
                        <h3>Package Managers</h3>
                        <p>{{ package_managers }}</p>
                    </div>
                </div>
                
                <h2>Vulnerability Summary</h2>
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 10px;">Severity</th>
                        <th style="border: 1px solid #ddd; padding: 10px;">Count</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 10px;" class="critical">Critical</td>
                        <td style="border: 1px solid #ddd; padding: 10px;">{{ vulnerabilities.critical }}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 10px;" class="high">High</td>
                        <td style="border: 1px solid #ddd; padding: 10px;">{{ vulnerabilities.high }}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 10px;" class="medium">Medium</td>
                        <td style="border: 1px solid #ddd; padding: 10px;">{{ vulnerabilities.medium }}</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 10px;" class="low">Low</td>
                        <td style="border: 1px solid #ddd; padding: 10px;">{{ vulnerabilities.low }}</td>
                    </tr>
                </table>
                
                <h2>Recommendations</h2>
                <ul>
                    <li>Run dependency updates regularly (weekly recommended)</li>
                    <li>Review and apply security patches immediately for critical vulnerabilities</li>
                    <li>Consider using automated dependency update tools</li>
                    <li>Maintain an allow-list of approved licenses</li>
                    <li>Generate and store SBOM for compliance</li>
                </ul>
            </body>
            </html>
            """
            
            from string import Template
            template = Template(html_template)
            html_report = template.substitute(
                repository=report["repository"],
                date=report["timestamp"],
                total_dependencies=report["total_dependencies"],
                package_managers=", ".join(report["package_managers"]),
                vulnerabilities=report["vulnerabilities"]
            )
            
            with open("dependency-report.html", "w") as f:
                f.write(html_report)
            
            with open("dependency-summary.json", "w") as f:
                json.dump(report, f, indent=2)
            
            # Create markdown summary for PR comment
            md_summary = f"""
            ## Dependency Security Scan Results
            
            **Date**: {report['timestamp']}
            
            ### Vulnerabilities
            - **Critical**: {report['vulnerabilities']['critical']}
            - **High**: {report['vulnerabilities']['high']}
            - **Medium**: {report['vulnerabilities']['medium']}
            - **Low**: {report['vulnerabilities']['low']}
            
            ### Statistics
            - **Total Dependencies**: {report['total_dependencies']}
            - **Package Managers**: {', '.join(report['package_managers'])}
            
            {"‚ö†Ô∏è **Action Required**: Critical or high vulnerabilities detected!" if report['vulnerabilities']['critical'] > 0 or report['vulnerabilities']['high'] > 0 else "‚úÖ All dependency checks passed"}
            """
            
            with open("dependency-summary.md", "w") as f:
                f.write(md_summary)
            
            # Check thresholds
            if report["vulnerabilities"]["critical"] > 0:
                print(f"‚ùå {report['vulnerabilities']['critical']} critical vulnerabilities found!")
                return False
            
            if report["vulnerabilities"]["high"] > 5:
                print(f"‚ùå {report['vulnerabilities']['high']} high vulnerabilities exceed threshold (5)")
                return False
            
            return True
        
        if __name__ == "__main__":
            import sys
            if not generate_dependency_report():
                sys.exit(1)
        EOF
        
        python generate_dependency_report.py
        
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('dependency-summary.md', 'utf8');
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });
          
    - name: Upload Dependency Report
      uses: actions/upload-artifact@v4
      with:
        name: dependency-report
        path: |
          dependency-report.html
          dependency-summary.json
          dependency-summary.md
        retention-days: 90