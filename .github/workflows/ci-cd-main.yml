name: CI/CD Pipeline - Main

on:
  push:
    branches: [ main, staging, dev ]
  pull_request:
    branches: [ main, staging, dev ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'å¯¾è±¡ç’°å¢ƒ'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - main
      skip_tests:
        description: 'ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—'
        required: false
        default: false
        type: boolean

env:
  # ã‚°ãƒ­ãƒ¼ãƒãƒ«ç’°å¢ƒå¤‰æ•°
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  
jobs:
  # =============================================================================
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  # =============================================================================
  security-scan:
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    permissions:
      contents: read
      security-events: write
      actions: read
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: GitLeaksç§˜å¯†æƒ…å ±ã‚¹ã‚­ãƒ£ãƒ³
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Semgrepã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/owasp-top-ten
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
      
      - name: TruffleHogç§˜å¯†æ¤œå‡º
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  code-quality:
    name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Markdownlintãƒã‚§ãƒƒã‚¯
        uses: articulate/actions-markdownlint@v1
        with:
          config: .markdownlint.json
          files: '**/*.md'
          ignore: 'node_modules'
      
      - name: Prettierå½¢å¼ãƒã‚§ãƒƒã‚¯
        uses: actionsx/prettier@v2
        with:
          args: --check .
      
      - name: YAMLlintãƒã‚§ãƒƒã‚¯
        uses: ibiqlik/action-yamllint@v3
        with:
          config_file: .yamllint.yml
          file_or_dir: .

  # =============================================================================
  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  # =============================================================================
  test:
    name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    if: (github.event_name == 'pull_request' || github.event_name == 'push') && !inputs.skip_tests
    
    strategy:
      matrix:
        test-type: [unit, integration, security]
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: Node.jsã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          if [ -f package.json ]; then
            npm ci
          fi
      
      - name: ${{ matrix.test-type }}ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          case "${{ matrix.test-type }}" in
            "unit")
              echo "ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
              # npm test
              ;;
            "integration")
              echo "ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
              # npm run test:integration
              ;;
            "security")
              echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
              # npm run test:security
              ;;
          esac
      
      - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.test-type }}
          path: |
            test-results/
            coverage/

  # =============================================================================
  # ãƒ“ãƒ«ãƒ‰ãƒ»æˆæœç‰©ä½œæˆ
  # =============================================================================
  build:
    name: ãƒ“ãƒ«ãƒ‰ãƒ»æˆæœç‰©ä½œæˆ
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      artifact-url: ${{ steps.upload.outputs.artifact-url }}
    
    steps:
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç”Ÿæˆ
        id: version
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
            VERSION="v$(date +'%Y%m%d')-$(echo ${{ github.sha }} | cut -c1-8)"
          else
            VERSION="${{ github.ref_name }}-$(date +'%Y%m%d')-$(echo ${{ github.sha }} | cut -c1-8)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"
      
      - name: æˆæœç‰©ä½œæˆ
        run: |
          mkdir -p build/
          
          # Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ã¨ã‚³ãƒ”ãƒ¼
          find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*" -exec cp {} build/ \;
          
          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
          echo "version: ${{ steps.version.outputs.version }}" > build/version.yml
          echo "build_date: $(date -Iseconds)" >> build/version.yml
          echo "commit: ${{ github.sha }}" >> build/version.yml
          echo "branch: ${{ github.ref_name }}" >> build/version.yml
      
      - name: æˆæœç‰©ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        id: upload
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ steps.version.outputs.version }}
          path: build/
          retention-days: 30

  # =============================================================================
  # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆï¼ˆç’°å¢ƒåˆ¥ï¼‰
  # =============================================================================
  deploy-dev:
    name: Devç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.ref == 'refs/heads/dev' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'dev')
    environment:
      name: dev
      url: https://dev.github-guidelines.sas-com.local
    
    steps:
      - name: æˆæœç‰©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v3
        with:
          name: build-${{ needs.build.outputs.version }}
          path: ./build
      
      - name: Devç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
        run: |
          echo "Devç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œä¸­..."
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ: dev.github-guidelines.sas-com.local"
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ needs.build.outputs.version }}"
          
          # å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰
          # aws s3 sync ./build s3://sas-github-guidelines-dev/
          # kubectl apply -f k8s/dev/
      
      - name: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        run: |
          echo "Devç’°å¢ƒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          # curl -f https://dev.github-guidelines.sas-com.local/health

  deploy-staging:
    name: Stagingç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: [build, test, deploy-dev]
    if: github.ref == 'refs/heads/staging' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.github-guidelines.sas-com.local
    
    steps:
      - name: æˆæœç‰©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v3
        with:
          name: build-${{ needs.build.outputs.version }}
          path: ./build
      
      - name: Stagingç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å‰æ‰¿èªå¾…æ©Ÿ
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: sas-github-admin
          minimum-approvals: 1
          issue-title: "Stagingç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èªè¦æ±‚"
          issue-body: |
            ## Stagingç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èªè¦æ±‚
            
            **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ${{ needs.build.outputs.version }}
            **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}
            **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
            
            ### å¤‰æ›´å†…å®¹
            - [å¤‰æ›´å†…å®¹ã®æ¦‚è¦ã‚’ã“ã“ã«è¨˜è¼‰]
            
            ### ãƒ†ã‚¹ãƒˆçµæœ
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: âœ… ãƒ‘ã‚¹
            - ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: âœ… ãƒ‘ã‚¹
            - è‡ªå‹•ãƒ†ã‚¹ãƒˆ: âœ… ãƒ‘ã‚¹
            
            **æ‰¿èªã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ**
      
      - name: Stagingç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
        run: |
          echo "Stagingç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œä¸­..."
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ: staging.github-guidelines.sas-com.local"
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ needs.build.outputs.version }}"
          
          # å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰
          # aws s3 sync ./build s3://sas-github-guidelines-staging/
          # kubectl apply -f k8s/staging/

  deploy-production:
    name: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
    runs-on: ubuntu-latest
    needs: [build, test, deploy-staging]
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'main')
    environment:
      name: production
      url: https://github-guidelines.sas-com.co.jp
    
    steps:
      - name: æˆæœç‰©ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v3
        with:
          name: build-${{ needs.build.outputs.version }}
          path: ./build
      
      - name: æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å‰æ‰¿èªå¾…æ©Ÿ
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: sas-github-admin,sas-tech-lead
          minimum-approvals: 2
          issue-title: "æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èªè¦æ±‚"
          issue-body: |
            ## æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èªè¦æ±‚ ğŸš¨
            
            **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ${{ needs.build.outputs.version }}
            **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref_name }}
            **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
            
            ### äº‹å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
            - [ ] Stagingç’°å¢ƒã§ã®å‹•ä½œç¢ºèªå®Œäº†
            - [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†
            - [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†
            - [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»ç¢ºèªæ¸ˆã¿
            - [ ] é–¢ä¿‚è€…ã¸ã®äº‹å‰é€šçŸ¥æ¸ˆã¿
            
            ### ãƒªã‚¹ã‚¯ã‚¢ã‚»ã‚¹ãƒ¡ãƒ³ãƒˆ
            - å½±éŸ¿åº¦: [é«˜/ä¸­/ä½]
            - ãƒªã‚¹ã‚¯: [èª¬æ˜]
            - è»½æ¸›ç­–: [èª¬æ˜]
            
            **2åã®æ‰¿èªãŒå¿…è¦ã§ã™**
      
      - name: æœ¬ç•ªç’°å¢ƒãƒ–ãƒ«ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤
        run: |
          echo "æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ–ãƒ«ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œä¸­..."
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ: github-guidelines.sas-com.co.jp"
          echo "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ needs.build.outputs.version }}"
          
          # ãƒ–ãƒ«ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ã®å®Ÿè£…
          # 1. ã‚°ãƒªãƒ¼ãƒ³ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
          # 2. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          # 3. ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆ
          # 4. ãƒ–ãƒ«ãƒ¼ç’°å¢ƒåœæ­¢
      
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤é€šçŸ¥
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: |
            æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
            ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${{ needs.build.outputs.version }}
            çµæœ: ${{ job.status }}

  # =============================================================================
  # å¾Œå‡¦ç†ãƒ»é€šçŸ¥
  # =============================================================================
  cleanup:
    name: å¾Œå‡¦ç†ãƒ»é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-dev, deploy-staging, deploy-production]
    if: always()
    
    steps:
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã‚µãƒãƒªãƒ¼ä½œæˆ
        run: |
          echo "## CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œçµæœ" > summary.md
          echo "" >> summary.md
          echo "**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: ${{ needs.build.outputs.version }}" >> summary.md
          echo "**å®Ÿè¡Œæ™‚é–“**: $(date)" >> summary.md
          echo "" >> summary.md
          echo "### ç’°å¢ƒåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ³" >> summary.md
          echo "- Dev: ${{ needs.deploy-dev.result }}" >> summary.md
          echo "- Staging: ${{ needs.deploy-staging.result }}" >> summary.md
          echo "- Production: ${{ needs.deploy-production.result }}" >> summary.md
      
      - name: Teamsé€šçŸ¥
        uses: skitionek/notify-microsoft-teams@master
        if: always()
        with:
          webhook_url: ${{ secrets.TEAMS_WEBHOOK_URL }}
          title: "GitHub Actionså®Ÿè¡Œå®Œäº†"
          message: |
            ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
            ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}
            å®Ÿè¡Œè€…: ${{ github.actor }}
            çµæœ: ${{ job.status }}