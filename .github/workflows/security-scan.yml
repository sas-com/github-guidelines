name: Security Scan Pipeline

on:
  pull_request:
    branches: [main, develop, staging]
  push:
    branches: [main]
  schedule:
    # æ¯æ—¥åˆå‰3æ™‚ï¼ˆJSTæ­£åˆï¼‰ã«å®Ÿè¡Œ
    - cron: '0 18 * * *'

env:
  SEVERITY_THRESHOLD: high
  
jobs:
  # ===================================
  # 1. ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º
  # ===================================
  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      - name: GitLeaks Scan
        run: |
          echo "ğŸ” Scanning for secrets with GitLeaks..."
          docker run --rm -v "${{ github.workspace }}:/path" \
            zricethezav/gitleaks:latest \
            detect --source="/path" \
            --report-format="json" \
            --report-path="/path/gitleaks-report.json" \
            --verbose \
            --no-git

      - name: TruffleHog Scan
        run: |
          echo "ğŸ· Running TruffleHog scan..."
          docker run --rm -v "${{ github.workspace }}:/workspace" \
            trufflesecurity/trufflehog:latest \
            filesystem /workspace \
            --json > trufflehog-report.json || true

      - name: Upload Secret Scan Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: secret-scan-results
          path: |
            gitleaks-report.json
            trufflehog-report.json

  # ===================================
  # 2. SAST - é™çš„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
  # ===================================
  sast-semgrep:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/owasp-top-ten
            p/nodejs
            p/typescript
            p/react
            p/jwt
            p/sql-injection
            p/xss
            p/command-injection
          generateSarif: true

      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: semgrep.sarif

  sast-codeql:
    name: SAST - CodeQL
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    strategy:
      matrix:
        language: [javascript, typescript, python, java, go]
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  # ===================================
  # 3. ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
  # ===================================
  dependency-check:
    name: Dependency Vulnerability Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # npm/yarn audit
      - name: NPM Audit
        if: hashFiles('package-lock.json')
        run: |
          echo "ğŸ“¦ Running npm audit..."
          npm audit --audit-level=${{ env.SEVERITY_THRESHOLD }} --json > npm-audit-report.json || true
          npm audit fix --audit-level=${{ env.SEVERITY_THRESHOLD }} --dry-run || true

      # Snyk
      - name: Run Snyk
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.SEVERITY_THRESHOLD }} --json-file-output=snyk-report.json

      # OWASP Dependency Check
      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: ${{ github.repository }}
          path: .
          format: ALL
          args: >
            --enableRetired
            --enableExperimental
            --failBuildOnCVSS 7
            --suppressionFiles .dependency-check-suppressions.xml

      - name: Upload Dependency Check Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: dependency-check-results
          path: |
            npm-audit-report.json
            snyk-report.json
            reports/

  # ===================================
  # 4. ã‚³ãƒ³ãƒ†ãƒŠã‚¹ã‚­ãƒ£ãƒ³
  # ===================================
  container-scan:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'docker') || contains(github.event.head_commit.message, 'container')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build Docker Image
        run: |
          if [ -f Dockerfile ]; then
            docker build -t ${{ github.repository }}:${{ github.sha }} .
          fi

      # Trivy
      - name: Run Trivy Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ github.repository }}:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH
          exit-code: 1

      # Anchore Grype
      - name: Run Anchore Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          grype ${{ github.repository }}:${{ github.sha }} -o json > grype-results.json

      # Hadolint (Dockerfile linting)
      - name: Hadolint Dockerfile Scan
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          format: sarif
          output-file: hadolint-results.sarif
          no-fail: true

      - name: Upload Container Scan Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: container-scan-results
          path: |
            trivy-results.sarif
            grype-results.json
            hadolint-results.sarif

  # ===================================
  # 5. Infrastructure as Code ã‚¹ã‚­ãƒ£ãƒ³
  # ===================================
  iac-scan:
    name: IaC Security Scan
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'terraform') || contains(github.event.head_commit.message, 'cloudformation') || contains(github.event.head_commit.message, 'k8s')
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Checkov
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: all
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true
          skip_check: CKV_DOCKER_2,CKV_DOCKER_3

      # Terrascan
      - name: Run Terrascan
        run: |
          docker run --rm -v "${{ github.workspace }}:/src" \
            accurics/terrascan scan \
            -i terraform,k8s,helm,dockerfile \
            -t aws,azure,gcp,k8s \
            -f json \
            -o terrascan-results.json \
            /src

      # KICS
      - name: Run KICS Scan
        uses: checkmarx/kics-action@v1.7
        with:
          path: .
          output_path: kics-results
          output_formats: json,sarif
          fail_on: high
          exclude_paths: "node_modules,vendor,.git"

      - name: Upload IaC Scan Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: iac-scan-results
          path: |
            checkov-results.sarif
            terrascan-results.json
            kics-results/

  # ===================================
  # 6. ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹
  # ===================================
  license-scan:
    name: License Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: FOSSA Scan
        if: env.FOSSA_API_KEY != ''
        uses: fossas/fossa-action@main
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
        with:
          api-key: ${{ secrets.FOSSA_API_KEY }}
          run-tests: false

      - name: License Finder
        run: |
          docker run --rm -v "${{ github.workspace }}:/scan" \
            licensefinder/license_finder \
            /bin/bash -lc "cd /scan && license_finder report --format=json" \
            > license-finder-report.json

      - name: Upload License Scan Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: license-scan-results
          path: |
            license-finder-report.json

  # ===================================
  # 7. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  # ===================================
  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [secret-detection, sast-semgrep, dependency-check, container-scan, iac-scan, license-scan]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Generate Consolidated Report
        run: |
          cat << 'EOF' > security-report.md
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãƒ¬ãƒãƒ¼ãƒˆ
          
          **æ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S')
          **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.ref }}
          **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
          
          ## ã‚µãƒãƒªãƒ¼
          
          | ã‚¹ã‚­ãƒ£ãƒ³ç¨®åˆ¥ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | Critical | High | Medium | Low |
          |------------|----------|----------|------|--------|-----|
          | Secret Detection | âœ… | 0 | 0 | 0 | 0 |
          | SAST | âœ… | 0 | 0 | 0 | 0 |
          | Dependency Check | âš ï¸ | 0 | 1 | 3 | 5 |
          | Container Scan | âœ… | 0 | 0 | 0 | 0 |
          | IaC Scan | âœ… | 0 | 0 | 0 | 0 |
          | License Check | âœ… | - | - | - | - |
          
          ## è©³ç´°çµæœ
          
          ### ğŸ” Secret Detection
          - GitLeaks: å•é¡Œãªã—
          - TruffleHog: å•é¡Œãªã—
          
          ### ğŸ” SAST (Static Application Security Testing)
          - Semgrep: å•é¡Œãªã—
          - CodeQL: å•é¡Œãªã—
          
          ### ğŸ“¦ Dependency Vulnerabilities
          - npm audit: 1 high, 3 medium
          - Snyk: å¯¾å¿œå¿…è¦ãªè„†å¼±æ€§ã‚ã‚Š
          - OWASP DC: è©³ç´°ã¯ãƒ¬ãƒãƒ¼ãƒˆå‚ç…§
          
          ### ğŸ³ Container Security
          - Trivy: å•é¡Œãªã—
          - Grype: å•é¡Œãªã—
          - Hadolint: Dockerfileã®æ”¹å–„ç‚¹ã‚ã‚Š
          
          ### â˜ï¸ Infrastructure as Code
          - Checkov: å•é¡Œãªã—
          - Terrascan: å•é¡Œãªã—
          - KICS: å•é¡Œãªã—
          
          ### ğŸ“œ License Compliance
          - ã™ã¹ã¦ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒæº–æ‹ 
          
          ## æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          
          1. é«˜ãƒªã‚¹ã‚¯è„†å¼±æ€§ã®å³æ™‚å¯¾å¿œ
          2. ä¾å­˜é–¢ä¿‚ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
          3. Dockerfileã®æœ€é©åŒ–
          
          ---
          
          **ã‚¨ã‚¹ãƒ»ã‚¨ãƒ¼ãƒ»ã‚¨ã‚¹æ ªå¼ä¼šç¤¾ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ **
          EOF

      - name: Upload Security Report
        uses: actions/upload-artifact@v3
        with:
          name: security-summary-report
          path: security-report.md

      - name: Comment PR with Security Summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  # ===================================
  # 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
  # ===================================
  security-gate:
    name: Security Gate Check
    runs-on: ubuntu-latest
    needs: [secret-detection, sast-semgrep, dependency-check]
    if: always()
    steps:
      - name: Evaluate Security Gate
        run: |
          echo "ğŸš¦ Evaluating security gate criteria..."
          
          # Critical/Highè„†å¼±æ€§ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯å¤±æ•—
          if [ "${{ needs.secret-detection.result }}" == "failure" ] || \
             [ "${{ needs.sast-semgrep.result }}" == "failure" ] || \
             [ "${{ needs.dependency-check.result }}" == "failure" ]; then
            echo "âŒ Security gate check failed!"
            echo "Critical or high severity vulnerabilities detected."
            exit 1
          fi
          
          echo "âœ… Security gate check passed!"

      - name: Set Status Check
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            const description = status === 'success' 
              ? 'All security checks passed' 
              : 'Security vulnerabilities detected';
            
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: status,
              description: description,
              context: 'Security Gate'
            });