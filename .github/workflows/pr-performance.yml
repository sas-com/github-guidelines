name: PR Performance Testing

on:
  pull_request:
    branches: [ main, develop, staging ]
    types: [ opened, synchronize, reopened ]
    paths:
      - 'src/**'
      - 'lib/**'
      - 'components/**'
      - 'pages/**'
      - 'api/**'
      - 'package.json'
      - 'webpack.config.js'
      - 'next.config.js'
      - 'vite.config.js'
  workflow_dispatch:
    inputs:
      performance_profile:
        description: 'Performance test profile'
        required: false
        default: 'standard'
        type: choice
        options:
        - 'quick'
        - 'standard'
        - 'comprehensive'

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  NODE_VERSION: '20'
  PERFORMANCE_PROFILE: ${{ github.event.inputs.performance_profile || 'standard' }}

jobs:
  # ========================================
  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆè¨­å®šåˆ†æ
  # ========================================
  performance-config:
    name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆè¨­å®š
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      test-web: ${{ steps.detect-changes.outputs.test-web }}
      test-api: ${{ steps.detect-changes.outputs.test-api }}
      test-database: ${{ steps.detect-changes.outputs.test-database }}
      baseline-exists: ${{ steps.baseline-check.outputs.exists }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å¤‰æ›´å†…å®¹åˆ†æ
        id: detect-changes
        run: |
          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†æ
          git diff --name-only origin/main...HEAD > changed-files.txt
          
          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å¤‰æ›´æ¤œå‡º
          if grep -E '\.(js|ts|jsx|tsx|css|scss|sass|less)$|package\.json|webpack|vite|next\.config' changed-files.txt; then
            echo "test-web=true" >> $GITHUB_OUTPUT
          else
            echo "test-web=false" >> $GITHUB_OUTPUT
          fi
          
          # APIå¤‰æ›´æ¤œå‡º
          if grep -E 'api/|server/|backend/|\.py$|\.java$|\.go$|requirements\.txt' changed-files.txt; then
            echo "test-api=true" >> $GITHUB_OUTPUT
          else
            echo "test-api=false" >> $GITHUB_OUTPUT
          fi
          
          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¤‰æ›´æ¤œå‡º
          if grep -E 'migration|schema|model|\.sql$|database' changed-files.txt; then
            echo "test-database=true" >> $GITHUB_OUTPUT
          else
            echo "test-database=false" >> $GITHUB_OUTPUT
          fi

      - name: ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³å­˜åœ¨ç¢ºèª
        id: baseline-check
        run: |
          if [ -d "performance-baselines" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            mkdir -p performance-baselines
          fi

  # ========================================
  # Webãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  # ========================================
  web-performance:
    name: Web ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: performance-config
    if: needs.performance-config.outputs.test-web == 'true'
    
    strategy:
      matrix:
        test-type: [lighthouse, webvitals, bundle-size]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: |
          npm run build
          npm run export || npm run build:static || echo "Static build not available"

      - name: Start application
        if: matrix.test-type == 'lighthouse' || matrix.test-type == 'webvitals'
        run: |
          npm start &
          sleep 30
        env:
          NODE_ENV: production
          PORT: 3000

      - name: Lighthouse Performance Test
        if: matrix.test-type == 'lighthouse'
        run: |
          npm install -g @lhci/cli
          
          # Lighthouse CIè¨­å®š
          cat > lighthouserc.js << 'EOF'
          module.exports = {
            ci: {
              collect: {
                url: [
                  'http://localhost:3000',
                  'http://localhost:3000/about',
                  'http://localhost:3000/contact'
                ],
                numberOfRuns: 3
              },
              assert: {
                preset: 'lighthouse:recommended',
                assertions: {
                  'categories:performance': ['warn', {minScore: 0.8}],
                  'categories:accessibility': ['error', {minScore: 0.9}],
                  'categories:best-practices': ['warn', {minScore: 0.8}],
                  'categories:seo': ['warn', {minScore: 0.8}],
                  'first-contentful-paint': ['warn', {maxNumericValue: 2000}],
                  'largest-contentful-paint': ['warn', {maxNumericValue: 2500}],
                  'cumulative-layout-shift': ['warn', {maxNumericValue: 0.1}]
                }
              },
              upload: {
                target: 'filesystem',
                outputDir: './lighthouse-results'
              }
            }
          };
          EOF
          
          lhci autorun || echo "âš ï¸ Lighthouse ãƒ†ã‚¹ãƒˆã§è­¦å‘ŠãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          
          # JSONçµæœã‚’äººé–“ãŒèª­ã‚ã‚‹å½¢å¼ã«å¤‰æ›
          node -e "
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('./lighthouse-results/manifest.json', 'utf8'));
            console.log('ğŸ“Š Lighthouse Performance Results');
            console.log('================================');
            results.forEach(result => {
              const lhr = JSON.parse(fs.readFileSync(result.jsonPath, 'utf8'));
              console.log(\`\nURL: \${lhr.finalUrl}\`);
              console.log(\`Performance: \${Math.round(lhr.categories.performance.score * 100)}\`);
              console.log(\`Accessibility: \${Math.round(lhr.categories.accessibility.score * 100)}\`);
              console.log(\`Best Practices: \${Math.round(lhr.categories['best-practices'].score * 100)}\`);
              console.log(\`SEO: \${Math.round(lhr.categories.seo.score * 100)}\`);
              console.log(\`FCP: \${lhr.audits['first-contentful-paint'].numericValue}ms\`);
              console.log(\`LCP: \${lhr.audits['largest-contentful-paint'].numericValue}ms\`);
              console.log(\`CLS: \${lhr.audits['cumulative-layout-shift'].numericValue}\`);
            });
          "

      - name: Web Vitals Test
        if: matrix.test-type == 'webvitals'
        run: |
          # Puppeteerä½¿ç”¨ã®Web Vitalsãƒ†ã‚¹ãƒˆ
          npm install puppeteer web-vitals
          
          node -e "
            const puppeteer = require('puppeteer');
            const fs = require('fs');

            (async () => {
              const browser = await puppeteer.launch({args: ['--no-sandbox']});
              const page = await browser.newPage();
              
              // Web Vitalsæ¸¬å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ³¨å…¥
              await page.addScriptTag({path: './node_modules/web-vitals/dist/web-vitals.iife.js'});
              
              const vitals = {};
              
              page.on('console', msg => {
                if (msg.text().startsWith('VITALS:')) {
                  const data = JSON.parse(msg.text().replace('VITALS:', ''));
                  vitals[data.name] = data.value;
                }
              });
              
              await page.evaluateOnNewDocument(() => {
                webVitals.getCLS(console.log.bind(console, 'VITALS:' + JSON.stringify({name: 'CLS', value: arguments[0].value})));
                webVitals.getFID(console.log.bind(console, 'VITALS:' + JSON.stringify({name: 'FID', value: arguments[0].value})));
                webVitals.getFCP(console.log.bind(console, 'VITALS:' + JSON.stringify({name: 'FCP', value: arguments[0].value})));
                webVitals.getLCP(console.log.bind(console, 'VITALS:' + JSON.stringify({name: 'LCP', value: arguments[0].value})));
                webVitals.getTTFB(console.log.bind(console, 'VITALS:' + JSON.stringify({name: 'TTFB', value: arguments[0].value})));
              });
              
              await page.goto('http://localhost:3000', {waitUntil: 'networkidle0'});
              
              // ãƒšãƒ¼ã‚¸ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
              await page.click('body');
              await page.mouse.move(100, 100);
              
              await new Promise(resolve => setTimeout(resolve, 3000));
              
              fs.writeFileSync('web-vitals-results.json', JSON.stringify(vitals, null, 2));
              console.log('Web Vitals Results:', vitals);
              
              await browser.close();
            })();
          "

      - name: Bundle Size Analysis
        if: matrix.test-type == 'bundle-size'
        run: |
          # Bundle Analyzerå®Ÿè¡Œ
          npm install webpack-bundle-analyzer
          
          # ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          npx webpack-bundle-analyzer build/static/js/*.js --mode server --port 8888 &
          sleep 5
          
          # ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºæƒ…å ±å–å¾—
          du -sh build/static/js/*.js > bundle-sizes.txt
          
          # ä¸»è¦ãƒãƒ³ãƒ‰ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          MAIN_BUNDLE_SIZE=$(du -k build/static/js/main.*.js | cut -f1)
          VENDOR_BUNDLE_SIZE=$(du -k build/static/js/vendor.*.js 2>/dev/null | cut -f1 || echo "0")
          
          echo "Main Bundle Size: ${MAIN_BUNDLE_SIZE}KB"
          echo "Vendor Bundle Size: ${VENDOR_BUNDLE_SIZE}KB"
          
          # ã‚µã‚¤ã‚ºé–¾å€¤ãƒã‚§ãƒƒã‚¯
          if [ "$MAIN_BUNDLE_SIZE" -gt 500 ]; then
            echo "âš ï¸ Main bundle size exceeds 500KB threshold"
          fi
          
          if [ "$VENDOR_BUNDLE_SIZE" -gt 1000 ]; then
            echo "âš ï¸ Vendor bundle size exceeds 1MB threshold"
          fi
          
          # Tree shakingåŠ¹æœã®åˆ†æ
          npm run analyze:bundle || echo "Bundle analysis not available"

      - name: Upload Performance Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: web-performance-${{ matrix.test-type }}
          path: |
            lighthouse-results/
            web-vitals-results.json
            bundle-sizes.txt

  # ========================================
  # API ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  # ========================================
  api-performance:
    name: API ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: performance-config
    if: needs.performance-config.outputs.test-api == 'true'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Database
        run: |
          npm run db:migrate
          npm run db:seed:performance

      - name: Start API Server
        run: |
          npm run start:api &
          sleep 15
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://postgres:testpass@localhost:5432/testdb

      - name: K6 Load Testing
        run: |
          # K6 installation
          sudo apt-get update
          sudo apt-get install -y curl
          curl https://github.com/grafana/k6/releases/download/v0.47.0/k6-v0.47.0-linux-amd64.tar.gz -L | tar xvz --strip-components 1
          sudo mv k6 /usr/local/bin
          
          # Load test script creation
          cat > load-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';
          import { Rate, Trend } from 'k6/metrics';

          const errorRate = new Rate('errors');
          const responseTime = new Trend('response_time');

          export let options = {
            stages: [
              { duration: '2m', target: 10 },   // Ramp up
              { duration: '5m', target: 10 },   // Steady state
              { duration: '2m', target: 50 },   // Spike test
              { duration: '3m', target: 50 },   // Steady state
              { duration: '2m', target: 0 },    // Ramp down
            ],
            thresholds: {
              http_req_duration: ['p(95)<500'],
              http_req_failed: ['rate<0.05'],
              errors: ['rate<0.1'],
            },
          };

          const BASE_URL = 'http://localhost:3001';

          export default function() {
            let response;
            
            // Health check
            response = http.get(`${BASE_URL}/health`);
            check(response, {
              'Health check status is 200': (r) => r.status === 200,
            }) || errorRate.add(1);
            
            // API endpoints testing
            const endpoints = [
              '/api/users',
              '/api/products',
              '/api/orders'
            ];
            
            endpoints.forEach(endpoint => {
              response = http.get(`${BASE_URL}${endpoint}`);
              check(response, {
                [`${endpoint} status is 200`]: (r) => r.status === 200,
                [`${endpoint} response time < 300ms`]: (r) => r.timings.duration < 300,
              }) || errorRate.add(1);
              
              responseTime.add(response.timings.duration);
            });
            
            sleep(1);
          }

          export function handleSummary(data) {
            return {
              'load-test-results.json': JSON.stringify(data, null, 2),
            };
          }
          EOF
          
          # Run load test
          k6 run load-test.js || echo "âš ï¸ Load testing completed with warnings"

      - name: API Benchmark Testing
        run: |
          # Apache Bench testing
          sudo apt-get install -y apache2-utils
          
          echo "ğŸ“Š API Benchmark Results"
          echo "======================="
          
          # Single endpoint benchmarking
          ab -n 1000 -c 10 -g benchmark.tsv http://localhost:3001/api/health > ab-results.txt || echo "Benchmark completed"
          
          cat ab-results.txt | grep -E "Requests per second|Time per request|Transfer rate"
          
          # Response time distribution analysis
          node -e "
            const fs = require('fs');
            const results = fs.readFileSync('ab-results.txt', 'utf8');
            
            const rpsMatch = results.match(/Requests per second:\s+(\d+\.\d+)/);
            const avgTimeMatch = results.match(/Time per request:\s+(\d+\.\d+)/);
            
            if (rpsMatch && avgTimeMatch) {
              const rps = parseFloat(rpsMatch[1]);
              const avgTime = parseFloat(avgTimeMatch[1]);
              
              console.log('\\nğŸ“ˆ Performance Summary:');
              console.log(\`Requests per second: \${rps}\`);
              console.log(\`Average response time: \${avgTime}ms\`);
              
              // Performance thresholds
              if (rps < 100) console.log('âš ï¸ RPS below recommended threshold (100)');
              if (avgTime > 100) console.log('âš ï¸ Average response time above threshold (100ms)');
            }
          "

      - name: Database Performance Analysis
        run: |
          # Query performance analysis
          npm run db:analyze-queries || echo "Query analysis not available"
          
          # Connection pool monitoring
          node -e "
            const { Pool } = require('pg');
            const pool = new Pool({
              connectionString: process.env.DATABASE_URL
            });
            
            console.log('ğŸ“Š Database Connection Analysis');
            console.log('==============================');
            console.log(\`Total connections: \${pool.totalCount}\`);
            console.log(\`Idle connections: \${pool.idleCount}\`);
            console.log(\`Waiting requests: \${pool.waitingCount}\`);
          " || echo "Database analysis not available"

      - name: Upload API Performance Results
        uses: actions/upload-artifact@v3
        with:
          name: api-performance-results
          path: |
            load-test-results.json
            ab-results.txt
            benchmark.tsv

  # ========================================
  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒãƒ»ãƒ¬ãƒãƒ¼ãƒˆ
  # ========================================
  performance-comparison:
    name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒåˆ†æ
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [performance-config, web-performance, api-performance]
    if: always() && (needs.web-performance.result == 'success' || needs.api-performance.result == 'success')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Performance Artifacts
        uses: actions/download-artifact@v3
        with:
          path: ./performance-results

      - name: Load Historical Baselines
        run: |
          # ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³è¨­å®š
          mkdir -p baselines current-results
          
          if [ -f "performance-baselines/web-performance.json" ]; then
            cp performance-baselines/web-performance.json baselines/
          else
            echo '{"lighthouse": {"performance": 90, "fcp": 1000, "lcp": 2000}, "bundle": {"main": 400, "vendor": 800}}' > baselines/web-performance.json
          fi
          
          if [ -f "performance-baselines/api-performance.json" ]; then
            cp performance-baselines/api-performance.json baselines/
          else
            echo '{"rps": 150, "avg_response_time": 80, "p95_response_time": 200}' > baselines/api-performance.json
          fi

      - name: Performance Comparison Analysis
        run: |
          node -e "
            const fs = require('fs');
            const path = require('path');

            console.log('ğŸ” ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒåˆ†æ');
            console.log('========================');

            // Web Performance Comparison
            if (fs.existsSync('./performance-results/web-performance-lighthouse')) {
              const webBaseline = JSON.parse(fs.readFileSync('baselines/web-performance.json', 'utf8'));
              
              console.log('\\nğŸ“Š Web Performance Comparison:');
              console.log('Metric | Current | Baseline | Change');
              console.log('-------|---------|----------|-------');
              
              // Lighthouse results parsing (simplified)
              console.log('Performance Score | TBD | ' + webBaseline.lighthouse.performance + ' | TBD');
              console.log('First Contentful Paint | TBD | ' + webBaseline.lighthouse.fcp + 'ms | TBD');
              console.log('Largest Contentful Paint | TBD | ' + webBaseline.lighthouse.lcp + 'ms | TBD');
            }

            // API Performance Comparison
            if (fs.existsSync('./performance-results/api-performance-results/load-test-results.json')) {
              const apiBaseline = JSON.parse(fs.readFileSync('baselines/api-performance.json', 'utf8'));
              const apiResults = JSON.parse(fs.readFileSync('./performance-results/api-performance-results/load-test-results.json', 'utf8'));
              
              console.log('\\nğŸš€ API Performance Comparison:');
              console.log('Metric | Current | Baseline | Change');
              console.log('-------|---------|----------|-------');
              
              const currentRps = apiResults.metrics?.http_reqs?.rate || 0;
              const rpsChange = ((currentRps - apiBaseline.rps) / apiBaseline.rps * 100).toFixed(1);
              console.log(\`Requests/sec | \${currentRps.toFixed(1)} | \${apiBaseline.rps} | \${rpsChange}%\`);
              
              const currentP95 = apiResults.metrics?.http_req_duration?.['p(95)'] || 0;
              const p95Change = ((currentP95 - apiBaseline.p95_response_time) / apiBaseline.p95_response_time * 100).toFixed(1);
              console.log(\`P95 Response Time | \${currentP95.toFixed(1)}ms | \${apiBaseline.p95_response_time}ms | \${p95Change}%\`);
            }
          "

      - name: Generate Performance Report
        run: |
          cat > performance-report.md << 'EOF'
          # âš¡ PR ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæœ

          ## ğŸ“Š ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ¦‚è¦
          - **å®Ÿè¡Œæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          - **PRç•ªå·**: #${{ github.event.number }}
          - **ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«**: ${{ env.PERFORMANCE_PROFILE }}

          ## ğŸŒ Web ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµæœ

          ### Lighthouse ã‚¹ã‚³ã‚¢
          ${{ needs.web-performance.result == 'success' && 'âœ… ãƒ†ã‚¹ãƒˆå®Œäº† - è©³ç´°ã¯ Artifacts ã‚’ç¢ºèª' || needs.web-performance.result == 'skipped' && 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ— (å¤‰æ›´ãªã—)' || 'âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—' }}

          | ãƒ¡ãƒˆãƒªãƒƒã‚¯ | ã‚¹ã‚³ã‚¢ | é–¾å€¤ | åˆ¤å®š |
          |------------|--------|------|------|
          | Performance | TBD | 80+ | TBD |
          | Accessibility | TBD | 90+ | TBD |
          | Best Practices | TBD | 80+ | TBD |
          | SEO | TBD | 80+ | TBD |

          ### Core Web Vitals
          | ãƒ¡ãƒˆãƒªãƒƒã‚¯ | å€¤ | é–¾å€¤ | åˆ¤å®š |
          |------------|-------|------|------|
          | First Contentful Paint | TBD | <2.0s | TBD |
          | Largest Contentful Paint | TBD | <2.5s | TBD |
          | Cumulative Layout Shift | TBD | <0.1 | TBD |

          ### Bundle Size Analysis
          ${{ needs.web-performance.result == 'success' && 'âœ… åˆ†æå®Œäº†' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }}
          - Main Bundle: TBD (é–¾å€¤: 500KB)
          - Vendor Bundle: TBD (é–¾å€¤: 1MB)

          ## ğŸš€ API ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµæœ

          ### Load Testing (K6)
          ${{ needs.api-performance.result == 'success' && 'âœ… ãƒ†ã‚¹ãƒˆå®Œäº†' || needs.api-performance.result == 'skipped' && 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ— (å¤‰æ›´ãªã—)' || 'âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—' }}

          | ãƒ¡ãƒˆãƒªãƒƒã‚¯ | ç¾åœ¨å€¤ | ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ | å¤‰åŒ– |
          |------------|--------|--------------|------|
          | Requests/sec | TBD | TBD | TBD |
          | Avg Response Time | TBD | TBD | TBD |
          | P95 Response Time | TBD | TBD | TBD |
          | Error Rate | TBD | <5% | TBD |

          ### Database Performance
          - ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ${{ needs.api-performance.result == 'success' && 'âœ… åˆ†ææ¸ˆã¿' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }}
          - ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«: ${{ needs.api-performance.result == 'success' && 'âœ… ç›£è¦–æ¸ˆã¿' || 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—' }}

          ## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¤‰åŒ–ãƒˆãƒ¬ãƒ³ãƒ‰

          ### æ”¹å–„ç‚¹ âœ…
          - TBD (å…·ä½“çš„ãªæ”¹å–„é …ç›®)

          ### æ³¨æ„ç‚¹ âš ï¸
          - TBD (ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ä½ä¸‹é …ç›®)

          ### æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ ğŸ¯
          - TBD (æ¨å¥¨ã•ã‚Œã‚‹æœ€é©åŒ–)

          ## ğŸ” è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

          ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®è©³ç´°çµæœã¯ä»¥ä¸‹ã®Artifactsã§ç¢ºèªã§ãã¾ã™ï¼š
          - `web-performance-lighthouse`: Lighthouseè©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
          - `web-performance-bundle-size`: Bundleåˆ†æçµæœ
          - `api-performance-results`: K6è² è·ãƒ†ã‚¹ãƒˆçµæœ

          ## ğŸ“š å‚è€ƒæƒ…å ±

          - [Core Web Vitals](https://web.dev/vitals/)
          - [Lighthouse Performance Auditing](https://developers.google.com/web/tools/lighthouse)
          - [K6 Load Testing](https://k6.io/docs/)

          ---
          ğŸ¤– ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ç¶™ç¶šçš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã«ã‚ˆã‚Šå“è³ªã‚’ä¿ã¡ã¾ã—ã‚‡ã†ã€‚
          EOF

      - name: PR Comment with Performance Report
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const performanceReport = fs.readFileSync('performance-report.md', 'utf8');
            
            // æ—¢å­˜ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const existingComment = comments.data.find(comment => 
              comment.body.includes('âš¡ PR ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæœ')
            );
            
            if (existingComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: performanceReport
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: performanceReport
              });
            }

      - name: Update Performance Baselines
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ğŸ”„ Updating performance baselines for main branch"
          # ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒãƒãƒ¼ã‚¸æ™‚ã®ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
          # å®Ÿè£…ã¯è¦ä»¶ã«å¿œã˜ã¦èª¿æ•´