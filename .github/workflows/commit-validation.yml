name: ğŸ” Commit Message Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop, staging]
  push:
    branches: [main, develop, staging]

jobs:
  validate-commits:
    name: ğŸ“‹ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œè¨¼
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          # Install additional tools if needed
          npm install -g @commitlint/cli @commitlint/config-conventional

      - name: ğŸ›¡ï¸ Make validation scripts executable
        run: |
          chmod +x scripts/validation/validate-commit-message.sh
          chmod +x scripts/commit-hooks/commit-msg

      - name: ğŸ“‹ Validate commit messages with commitlint
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ” Validating commits in PR #${{ github.event.number }}"
          
          # Get commits in this PR
          COMMITS=$(git rev-list --reverse HEAD^..${{ github.event.after }})
          
          echo "Commits to validate:"
          for commit in $COMMITS; do
            echo "  - $(git log --oneline -1 $commit)"
          done
          
          # Validate each commit
          for commit in $COMMITS; do
            echo "::group::Validating commit $commit"
            COMMIT_MSG=$(git log --format=%B -n 1 $commit)
            echo "$COMMIT_MSG" | npx commitlint --verbose
            echo "::endgroup::"
          done

      - name: ğŸ” Custom SAS validation
        if: github.event_name == 'pull_request'  
        run: |
          echo "ğŸ” Running SAS-specific commit validation"
          
          COMMITS=$(git rev-list --reverse HEAD^..${{ github.event.after }})
          VALIDATION_RESULTS=""
          FAILED_COMMITS=()
          
          for commit in $COMMITS; do
            echo "::group::SAS Validation for commit $commit"
            
            COMMIT_MSG=$(git log --format=%B -n 1 $commit)
            COMMIT_SUBJECT=$(git log --format=%s -n 1 $commit)
            
            echo "Commit: $COMMIT_SUBJECT"
            
            # Create temporary file for validation
            TEMP_MSG_FILE="/tmp/commit-msg-$commit"
            echo "$COMMIT_MSG" > "$TEMP_MSG_FILE"
            
            # Run custom validation
            if ./scripts/validation/validate-commit-message.sh "$TEMP_MSG_FILE"; then
              echo "âœ… Commit $commit passed SAS validation"
              VALIDATION_RESULTS+="âœ… \`$commit\`: $COMMIT_SUBJECT\n"
            else
              echo "âŒ Commit $commit failed SAS validation"
              VALIDATION_RESULTS+="âŒ \`$commit\`: $COMMIT_SUBJECT\n"
              FAILED_COMMITS+=($commit)
            fi
            
            rm -f "$TEMP_MSG_FILE"
            echo "::endgroup::"
          done
          
          # Export results for comment
          echo "VALIDATION_RESULTS<<EOF" >> $GITHUB_ENV
          echo -e "$VALIDATION_RESULTS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "FAILED_COUNT=${#FAILED_COMMITS[@]}" >> $GITHUB_ENV
          
          # Fail if any commits failed validation
          if [ ${#FAILED_COMMITS[@]} -gt 0 ]; then
            echo "::error::${#FAILED_COMMITS[@]} commit(s) failed SAS validation"
            exit 1
          fi

      - name: ğŸ“ Comment validation results on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { VALIDATION_RESULTS, FAILED_COUNT } = process.env;
            const prNumber = context.payload.pull_request.number;
            
            let status = '';
            let color = '';
            
            if (FAILED_COUNT === '0') {
              status = 'âœ… **ã™ã¹ã¦ã®ã‚³ãƒŸãƒƒãƒˆãŒè¦ç´„ã«é©åˆã—ã¦ã„ã¾ã™**';
              color = '28a745';
            } else {
              status = `âŒ **${FAILED_COUNT}å€‹ã®ã‚³ãƒŸãƒƒãƒˆãŒè¦ç´„ã«é©åˆã—ã¦ã„ã¾ã›ã‚“**`;
              color = 'dc3545';
            }
            
            const commentBody = `
            ## ğŸ” SAS ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œè¨¼çµæœ
            
            ${status}
            
            ### ğŸ“‹ æ¤œè¨¼çµæœè©³ç´°
            ${VALIDATION_RESULTS || 'No commits to validate.'}
            
            ### ğŸ“š å‚è€ƒè³‡æ–™
            - ğŸ“– [ã‚³ãƒŸãƒƒãƒˆè¦ç´„ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³](./COMMIT_CONVENTION_GUIDE.md)
            - ğŸ› ï¸ [ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰](./scripts/setup/README.md)  
            - ğŸŒ [Conventional Commits](https://www.conventionalcommits.org/)
            
            ### ğŸ’¡ ã‚ˆãã‚ã‚‹ä¿®æ­£ä¾‹
            \`\`\`diff
            - update: æ©Ÿèƒ½ã‚’ä¿®æ­£
            + fix(api): ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
            
            - feat: æ–°æ©Ÿèƒ½è¿½åŠ ã—ã¾ã—ãŸ
            + feat(auth): OAuth2.0ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’è¿½åŠ 
            
            - docs: READMEæ›´æ–°
            + docs(readme): ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã‚’æ›´æ–°
            \`\`\`
            
            <sub>ğŸ¤– ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ</sub>
            `;
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const existingComment = comments.find(comment => 
              comment.body.includes('ğŸ” SAS ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œè¨¼çµæœ')
            );
            
            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }

  security-scan:
    name: ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Scan for secrets in commit messages
        run: |
          echo "ğŸ” Scanning commit messages for potential secrets..."
          
          COMMITS=$(git rev-list --reverse HEAD^..${{ github.event.after }})
          SECURITY_ISSUES=()
          
          # Patterns to check for
          PATTERNS=(
            "password\s*[:=]\s*[\"']?[^\"'\s]+"
            "api[_-]?key\s*[:=]\s*[\"']?[^\"'\s]+"
            "secret\s*[:=]\s*[\"']?[^\"'\s]+"
            "token\s*[:=]\s*[\"']?[^\"'\s]+"
            "Bearer\s+[a-zA-Z0-9\.\-_]+"
            "[a-zA-Z0-9]{32,}"
            "mysql://.*:[^@]+@"
            "postgresql://.*:[^@]+@"
          )
          
          for commit in $COMMITS; do
            COMMIT_MSG=$(git log --format=%B -n 1 $commit)
            COMMIT_SUBJECT=$(git log --format=%s -n 1 $commit)
            
            for pattern in "${PATTERNS[@]}"; do
              if echo "$COMMIT_MSG" | grep -qiE "$pattern"; then
                echo "âš ï¸ Potential security issue in commit $commit: $COMMIT_SUBJECT"
                SECURITY_ISSUES+=("$commit: $COMMIT_SUBJECT")
              fi
            done
          done
          
          if [ ${#SECURITY_ISSUES[@]} -gt 0 ]; then
            echo "::error::Potential security issues found in commit messages"
            echo "SECURITY_ISSUES_FOUND=true" >> $GITHUB_ENV
            
            # Save issues for comment
            printf '%s\n' "${SECURITY_ISSUES[@]}" > /tmp/security_issues.txt
          else
            echo "âœ… No security issues found in commit messages"
            echo "SECURITY_ISSUES_FOUND=false" >> $GITHUB_ENV
          fi

      - name: ğŸ“ Comment security warnings
        if: env.SECURITY_ISSUES_FOUND == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            
            let issues = '';
            try {
              issues = fs.readFileSync('/tmp/security_issues.txt', 'utf8');
            } catch (error) {
              issues = 'Error reading security issues file';
            }
            
            const commentBody = `
            ## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Š
            
            âš ï¸ **ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ©Ÿå¯†æƒ…å ±ã®å¯èƒ½æ€§ãŒã‚ã‚‹å†…å®¹ãŒå«ã¾ã‚Œã¦ã„ã¾ã™**
            
            ### æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ:
            \`\`\`
            ${issues}
            \`\`\`
            
            ### å¯¾å¿œæ–¹æ³•:
            1. ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æ©Ÿå¯†æƒ…å ±ã‚’å‰Šé™¤
            2. å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ã®æ›¸ãæ›ãˆ
            3. æ¼æ´©ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚‹æƒ…å ±ã®ç„¡åŠ¹åŒ–
            
            ### æ³¨æ„äº‹é …:
            - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€APIã‚­ãƒ¼ã€ãƒˆãƒ¼ã‚¯ãƒ³ã¯çµ¶å¯¾ã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„
            - å€‹äººæƒ…å ±ã‚„æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã¯å«ã‚ãªã„
            - ç–‘ã„ãŒã‚ã‚‹å ´åˆã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ (security@sas-com.com)ã«é€£çµ¡
            
            <sub>ğŸ¤– ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ</sub>
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });

  quality-metrics:
    name: ğŸ“Š å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ˆ Generate commit metrics
        run: |
          echo "ğŸ“Š Generating commit quality metrics..."
          
          COMMITS=$(git rev-list --reverse HEAD^..${{ github.event.after }})
          TOTAL_COMMITS=$(echo "$COMMITS" | wc -l)
          
          # Count by type
          FEAT_COUNT=0
          FIX_COUNT=0
          DOCS_COUNT=0
          OTHER_COUNT=0
          
          # Analyze each commit
          for commit in $COMMITS; do
            SUBJECT=$(git log --format=%s -n 1 $commit)
            
            if [[ $SUBJECT =~ ^feat ]]; then
              ((FEAT_COUNT++))
            elif [[ $SUBJECT =~ ^fix ]]; then
              ((FIX_COUNT++))
            elif [[ $SUBJECT =~ ^docs ]]; then
              ((DOCS_COUNT++))
            else
              ((OTHER_COUNT++))
            fi
          done
          
          # Calculate percentages
          FEAT_PERCENT=$((FEAT_COUNT * 100 / TOTAL_COMMITS))
          FIX_PERCENT=$((FIX_COUNT * 100 / TOTAL_COMMITS))
          DOCS_PERCENT=$((DOCS_COUNT * 100 / TOTAL_COMMITS))
          OTHER_PERCENT=$((OTHER_COUNT * 100 / TOTAL_COMMITS))
          
          # Save metrics
          echo "TOTAL_COMMITS=$TOTAL_COMMITS" >> $GITHUB_ENV
          echo "FEAT_COUNT=$FEAT_COUNT" >> $GITHUB_ENV
          echo "FIX_COUNT=$FIX_COUNT" >> $GITHUB_ENV
          echo "DOCS_COUNT=$DOCS_COUNT" >> $GITHUB_ENV
          echo "OTHER_COUNT=$OTHER_COUNT" >> $GITHUB_ENV
          echo "FEAT_PERCENT=$FEAT_PERCENT" >> $GITHUB_ENV
          echo "FIX_PERCENT=$FIX_PERCENT" >> $GITHUB_ENV
          echo "DOCS_PERCENT=$DOCS_PERCENT" >> $GITHUB_ENV
          echo "OTHER_PERCENT=$OTHER_PERCENT" >> $GITHUB_ENV

      - name: ğŸ“Š Comment quality metrics
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const {
              TOTAL_COMMITS, FEAT_COUNT, FIX_COUNT, DOCS_COUNT, OTHER_COUNT,
              FEAT_PERCENT, FIX_PERCENT, DOCS_PERCENT, OTHER_PERCENT
            } = process.env;
            
            const prNumber = context.payload.pull_request.number;
            
            const commentBody = `
            ## ğŸ“Š ã‚³ãƒŸãƒƒãƒˆå“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
            
            ### ğŸ“ˆ ã“ã®PRã®çµ±è¨ˆ
            
            - **ç·ã‚³ãƒŸãƒƒãƒˆæ•°**: ${TOTAL_COMMITS}
            
            | ã‚¿ã‚¤ãƒ— | ä»¶æ•° | å‰²åˆ | èª¬æ˜ |
            |-------|-----|------|------|
            | ğŸ†• feat | ${FEAT_COUNT} | ${FEAT_PERCENT}% | æ–°æ©Ÿèƒ½ã®è¿½åŠ  |
            | ğŸ› fix | ${FIX_COUNT} | ${FIX_PERCENT}% | ãƒã‚°ä¿®æ­£ |
            | ğŸ“š docs | ${DOCS_COUNT} | ${DOCS_PERCENT}% | ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ |
            | ğŸ”§ other | ${OTHER_COUNT} | ${OTHER_PERCENT}% | ãã®ä»– |
            
            ### ğŸ’¡ å“è³ªæŒ‡æ¨™
            ${FIX_PERCENT > 50 ? 'âš ï¸ ãƒã‚°ä¿®æ­£ã®å‰²åˆãŒé«˜ã‚ã§ã™ã€‚äº‹å‰ãƒ†ã‚¹ãƒˆã®å¼·åŒ–ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚' : ''}
            ${FEAT_PERCENT > 70 ? 'ğŸš€ æ–°æ©Ÿèƒ½ãŒå¤šãå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ãƒªãƒªãƒ¼ã‚¹è¨ˆç”»ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚' : ''}
            ${DOCS_PERCENT === 0 && TOTAL_COMMITS > 3 ? 'ğŸ“ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ã‚‚æ¤œè¨ã—ã¦ãã ã•ã„ã€‚' : ''}
            
            <sub>ğŸ“Š Generated by GitHub Actions</sub>
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });