name: PR Checklist Automation

on:
  pull_request:
    types: [opened, edited, synchronize]
  pull_request_review:
    types: [submitted]

jobs:
  auto-checks:
    name: Automated PR Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      # ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ãƒã‚§ãƒƒã‚¯
      - name: Run Linter
        id: lint
        run: |
          npm ci
          npm run lint --if-present
        continue-on-error: true

      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
      - name: Security Scan - Secrets Detection
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}

      # ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
      - name: Dependency Vulnerability Check
        id: deps-check
        run: |
          npm audit --audit-level=moderate
        continue-on-error: true

      # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
      - name: Run Tests with Coverage
        id: test
        run: |
          npm test --if-present -- --coverage
        continue-on-error: true

      # ã‚³ãƒ¼ãƒ‰å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
      - name: Code Quality Metrics
        id: quality
        run: |
          echo "## ğŸ“Š Code Quality Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´çµ±è¨ˆ
          echo "### ğŸ“ˆ Change Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- Files changed: $(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Lines added: $(git diff --stat ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | tail -1 | awk '{print $4}')" >> $GITHUB_STEP_SUMMARY
          echo "- Lines deleted: $(git diff --stat ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | tail -1 | awk '{print $6}')" >> $GITHUB_STEP_SUMMARY

      # PRç¨®åˆ¥ã®è‡ªå‹•åˆ¤å®š
      - name: Detect PR Type
        id: pr-type
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          
          if [[ "$PR_TITLE" =~ ^feat|^feature ]]; then
            echo "pr_type=feature" >> $GITHUB_OUTPUT
            echo "ğŸš€ **PR Type: Feature**" >> $GITHUB_STEP_SUMMARY
          elif [[ "$PR_TITLE" =~ ^fix|^bugfix ]]; then
            echo "pr_type=bugfix" >> $GITHUB_OUTPUT
            echo "ğŸ› **PR Type: Bugfix**" >> $GITHUB_STEP_SUMMARY
          elif [[ "$PR_TITLE" =~ ^hotfix ]]; then
            echo "pr_type=hotfix" >> $GITHUB_OUTPUT
            echo "ğŸ”¥ **PR Type: Hotfix**" >> $GITHUB_STEP_SUMMARY
          elif [[ "$PR_TITLE" =~ ^refactor ]]; then
            echo "pr_type=refactor" >> $GITHUB_OUTPUT
            echo "â™»ï¸ **PR Type: Refactoring**" >> $GITHUB_STEP_SUMMARY
          else
            echo "pr_type=other" >> $GITHUB_OUTPUT
            echo "ğŸ“‹ **PR Type: Other**" >> $GITHUB_STEP_SUMMARY
          fi

      # ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèªçŠ¶æ³
      - name: Checklist Validation
        id: checklist
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          
          # ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚«ã‚¦ãƒ³ãƒˆ
          TOTAL_CHECKS=$(echo "$PR_BODY" | grep -c "\- \[" || true)
          CHECKED=$(echo "$PR_BODY" | grep -c "\- \[x\]" || true)
          
          echo "## âœ… Checklist Status" >> $GITHUB_STEP_SUMMARY
          echo "- Total items: $TOTAL_CHECKS" >> $GITHUB_STEP_SUMMARY
          echo "- Completed: $CHECKED" >> $GITHUB_STEP_SUMMARY
          echo "- Remaining: $((TOTAL_CHECKS - CHECKED))" >> $GITHUB_STEP_SUMMARY
          
          if [ $TOTAL_CHECKS -gt 0 ]; then
            PERCENTAGE=$((CHECKED * 100 / TOTAL_CHECKS))
            echo "- Completion: ${PERCENTAGE}%" >> $GITHUB_STEP_SUMMARY
          fi

      # è‡ªå‹•ãƒã‚§ãƒƒã‚¯çµæœã®ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆ
      - name: Create Check Results Comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // æ—¢å­˜ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('## ğŸ¤– Automated PR Check Results')
            );
            
            // ãƒã‚§ãƒƒã‚¯çµæœã®ä½œæˆ
            let checkResults = `## ğŸ¤– Automated PR Check Results\n\n`;
            checkResults += `### ğŸ“‹ PR Type: ${{ steps.pr-type.outputs.pr_type }}\n\n`;
            
            // å„ãƒã‚§ãƒƒã‚¯ã®çµæœ
            checkResults += `### âœ… Automated Checks\n`;
            checkResults += `- Linting: ${{ steps.lint.outcome == 'success' && 'âœ… Passed' || 'âš ï¸ Failed' }}\n`;
            checkResults += `- Security Scan: âœ… Completed\n`;
            checkResults += `- Dependency Check: ${{ steps.deps-check.outcome == 'success' && 'âœ… No vulnerabilities' || 'âš ï¸ Vulnerabilities found' }}\n`;
            checkResults += `- Tests: ${{ steps.test.outcome == 'success' && 'âœ… All tests passed' || 'âš ï¸ Some tests failed' }}\n`;
            
            checkResults += `\n### ğŸ“Š Metrics\n`;
            checkResults += `See [workflow summary](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }}) for detailed metrics.\n`;
            
            checkResults += `\n### ğŸ“š Resources\n`;
            checkResults += `- [PR Review Guidelines](/PR_REVIEW_GUIDELINES.md)\n`;
            checkResults += `- [PR Review Checklist](/PR_REVIEW_CHECKLIST.md)\n`;
            
            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body: checkResults
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: checkResults
              });
            }

  pr-size-label:
    name: Add PR Size Label
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Calculate PR Size and Add Label
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // PRæƒ…å ±ã‚’å–å¾—
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });
            
            const additions = pr.additions;
            const deletions = pr.deletions;
            const changes = additions + deletions;
            
            // ã‚µã‚¤ã‚ºã«åŸºã¥ããƒ©ãƒ™ãƒ«ã‚’æ±ºå®š
            let sizeLabel = '';
            if (changes <= 50) {
              sizeLabel = 'size/XS';
            } else if (changes <= 200) {
              sizeLabel = 'size/S';
            } else if (changes <= 500) {
              sizeLabel = 'size/M';
            } else if (changes <= 1000) {
              sizeLabel = 'size/L';
            } else {
              sizeLabel = 'size/XL';
            }
            
            // æ—¢å­˜ã®ã‚µã‚¤ã‚ºãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner,
              repo,
              issue_number: prNumber,
            });
            
            const sizeLabels = labels.filter(label => label.name.startsWith('size/'));
            for (const label of sizeLabels) {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: prNumber,
                name: label.name,
              }).catch(() => {});
            }
            
            // æ–°ã—ã„ã‚µã‚¤ã‚ºãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: prNumber,
              labels: [sizeLabel],
            }).catch(() => {});

  review-assignment:
    name: Auto-assign Reviewers
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    
    steps:
      - name: Auto-assign reviewers based on PR type
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prTitle = context.payload.pull_request.title;
            
            // PRç¨®åˆ¥ã«åŸºã¥ããƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã®æ±ºå®š
            let reviewers = [];
            
            if (prTitle.includes('security') || prTitle.includes('auth')) {
              // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®å¤‰æ›´
              reviewers.push('security-team');
            }
            
            if (prTitle.includes('api') || prTitle.includes('endpoint')) {
              // APIå¤‰æ›´
              reviewers.push('backend-team');
            }
            
            if (prTitle.includes('ui') || prTitle.includes('frontend')) {
              // UIå¤‰æ›´
              reviewers.push('frontend-team');
            }
            
            if (prTitle.includes('hotfix') || prTitle.includes('critical')) {
              // ç·Šæ€¥ä¿®æ­£
              reviewers.push('senior-engineers');
            }
            
            // ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã®å‰²ã‚Šå½“ã¦ï¼ˆå­˜åœ¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼/ãƒãƒ¼ãƒ ã®ã¿ï¼‰
            if (reviewers.length > 0) {
              try {
                await github.rest.pulls.requestReviewers({
                  owner,
                  repo,
                  pull_number: prNumber,
                  team_reviewers: reviewers.filter(r => r.includes('team')),
                  reviewers: reviewers.filter(r => !r.includes('team')),
                });
              } catch (error) {
                console.log('Could not assign some reviewers:', error.message);
              }
            }