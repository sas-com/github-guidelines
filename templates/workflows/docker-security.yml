# Docker ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
# ã‚¨ã‚¹ãƒ»ã‚¨ãƒ¼ãƒ»ã‚¨ã‚¹æ ªå¼ä¼šç¤¾
# ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 1.0.0

name: Docker Security Scan

on:
  push:
    branches: 
      - main
      - develop
    paths:
      - 'Dockerfile*'
      - 'docker-compose*.yml'
      - '.dockerignore'
  pull_request:
    branches: 
      - main
      - develop
    paths:
      - 'Dockerfile*'
      - 'docker-compose*.yml'
      - '.dockerignore'
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œ
    - cron: '0 17 * * *'  # UTCæ™‚é–“
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to scan'
        required: false
        default: 'latest'
        type: string
      scan_type:
        description: 'Type of security scan'
        required: false
        default: 'comprehensive'
        type: choice
        options:
          - quick
          - comprehensive
          - critical-only

permissions:
  contents: read
  security-events: write
  packages: read

env:
  REGISTRY_URL: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Dockerfileã®é™çš„è§£æ
  dockerfile-analysis:
    name: Dockerfile Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.1
      
      - name: Run Hadolint (Dockerfile linter)
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          format: sarif
          output-file: hadolint-results.sarif
          no-color: true
      
      - name: Upload Hadolint results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3.24.5
        if: always()
        with:
          sarif_file: hadolint-results.sarif
          category: dockerfile-analysis
      
      - name: Run Dockerfile security check with Checkov
        uses: bridgecrewio/checkov-action@v12.2697.0
        with:
          directory: .
          framework: dockerfile
          output_format: sarif
          output_file_path: checkov-dockerfile.sarif
      
      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v3.24.5
        if: always()
        with:
          sarif_file: checkov-dockerfile.sarif
          category: checkov-dockerfile

  # Docker Composeãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
  docker-compose-security:
    name: Docker Compose Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 8
    if: hashFiles('docker-compose*.yml') != ''
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.1
      
      - name: Validate Docker Compose files
        run: |
          for compose_file in docker-compose*.yml; do
            if [ -f "$compose_file" ]; then
              echo "Validating $compose_file"
              docker-compose -f "$compose_file" config -q
              
              # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®ãƒã‚§ãƒƒã‚¯
              echo "Checking security configurations in $compose_file"
              
              # ç‰¹æ¨©ãƒ¢ãƒ¼ãƒ‰ã®ä½¿ç”¨ãƒã‚§ãƒƒã‚¯
              if grep -q "privileged.*true" "$compose_file"; then
                echo "::warning::Privileged mode detected in $compose_file"
              fi
              
              # ãƒ›ã‚¹ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ä½¿ç”¨ãƒã‚§ãƒƒã‚¯
              if grep -q "network_mode.*host" "$compose_file"; then
                echo "::warning::Host network mode detected in $compose_file"
              fi
              
              # ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯
              if grep -q "/var/run/docker.sock" "$compose_file"; then
                echo "::error::Docker socket mount detected in $compose_file - High security risk!"
              fi
              
              # ç’°å¢ƒå¤‰æ•°ã§ã®æ©Ÿå¯†æƒ…å ±ãƒã‚§ãƒƒã‚¯
              if grep -qE "(PASSWORD|SECRET|KEY|TOKEN).*=" "$compose_file"; then
                echo "::warning::Potential hardcoded secrets detected in $compose_file"
              fi
            fi
          done

  # ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã¨ã‚¹ã‚­ãƒ£ãƒ³
  build-and-scan:
    name: Build and Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [dockerfile-analysis]
    
    permissions:
      contents: read
      security-events: write
      packages: write
    
    strategy:
      matrix:
        dockerfile: [Dockerfile]
        # è¤‡æ•°ã®DockerfileãŒã‚ã‚‹å ´åˆã¯é…åˆ—ã«è¿½åŠ 
        # dockerfile: [Dockerfile, Dockerfile.prod, Dockerfile.dev]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.1
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.2.0
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3.1.0
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5.5.1
        with:
          images: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix=sha-
            type=raw,value=security-scan
      
      - name: Build Docker image for scanning
        uses: docker/build-push-action@v5.3.0
        with:
          context: .
          file: ./${{ matrix.dockerfile }}
          load: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.18.0
        with:
          image-ref: ${{ steps.meta.outputs.tags }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'  # ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åœæ­¢ã—ãªã„
      
      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3.24.5
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy-vulnerability-scan'
      
      - name: Run Trivy configuration scan
        uses: aquasecurity/trivy-action@0.18.0
        with:
          scan-type: 'config'
          image-ref: ${{ steps.meta.outputs.tags }}
          format: 'sarif'
          output: 'trivy-config.sarif'
          exit-code: '0'
      
      - name: Upload Trivy config scan results
        uses: github/codeql-action/upload-sarif@v3.24.5
        if: always()
        with:
          sarif_file: 'trivy-config.sarif'
          category: 'trivy-config-scan'
      
      - name: Run Snyk Container scan
        continue-on-error: true
        uses: snyk/actions/docker@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ steps.meta.outputs.tags }}
          args: --severity-threshold=high --file=${{ matrix.dockerfile }}
      
      - name: Upload Snyk results to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3.24.5
        if: hashFiles('snyk.sarif') != ''
        with:
          sarif_file: snyk.sarif
          category: 'snyk-container-scan'
      
      - name: Docker Scout CVE scanning
        uses: docker/scout-action@v1.5.0
        with:
          command: cves
          image: ${{ steps.meta.outputs.tags }}
          sarif-file: scout-cves.sarif
          summary: true
      
      - name: Upload Docker Scout results
        uses: github/codeql-action/upload-sarif@v3.24.5
        if: hashFiles('scout-cves.sarif') != ''
        with:
          sarif_file: scout-cves.sarif
          category: 'docker-scout-cves'
      
      # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ãƒã‚§ãƒƒã‚¯
      - name: Analyze image size and layers
        run: |
          IMAGE_TAG="${{ steps.meta.outputs.tags }}"
          echo "ğŸ³ Docker Image Analysis"
          echo "========================"
          
          # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºç¢ºèª
          IMAGE_SIZE=$(docker images --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}" | grep -E "$(echo $IMAGE_TAG | cut -d: -f1)" | head -1 | awk '{print $2}')
          echo "Image Size: $IMAGE_SIZE"
          
          # ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ç¢ºèª
          LAYER_COUNT=$(docker history --no-trunc "$IMAGE_TAG" | wc -l)
          echo "Layer Count: $((LAYER_COUNT - 1))"  # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’é™¤ã
          
          # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºè­¦å‘Šï¼ˆ1GBä»¥ä¸Šï¼‰
          if docker images --format "{{.Size}}" "$IMAGE_TAG" | grep -qE "[0-9]+\.?[0-9]*GB"; then
            echo "::warning::Large image size detected: $IMAGE_SIZE"
          fi
          
          # ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°è­¦å‘Šï¼ˆ20å±¤ä»¥ä¸Šï¼‰
          if [ $((LAYER_COUNT - 1)) -gt 20 ]; then
            echo "::warning::High layer count: $((LAYER_COUNT - 1)) layers"
          fi
          
          # è©³ç´°ãªãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†æ
          echo "ğŸ“Š Layer Analysis:"
          docker history --no-trunc --format "table {{.CreatedBy}}\t{{.Size}}" "$IMAGE_TAG"
      
      - name: Check for security best practices
        run: |
          IMAGE_TAG="${{ steps.meta.outputs.tags }}"
          echo "ğŸ”’ Security Best Practices Check"
          echo "================================="
          
          # rootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          USER_ID=$(docker run --rm "$IMAGE_TAG" id -u 2>/dev/null || echo "unknown")
          if [ "$USER_ID" = "0" ]; then
            echo "::warning::Container running as root user"
          else
            echo "âœ… Container running as non-root user (UID: $USER_ID)"
          fi
          
          # ã‚·ã‚§ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          if docker run --rm "$IMAGE_TAG" which sh >/dev/null 2>&1; then
            echo "::warning::Shell found in image - consider distroless image"
          else
            echo "âœ… No shell found in image"
          fi
          
          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          for pkg_manager in apt yum apk; do
            if docker run --rm "$IMAGE_TAG" which $pkg_manager >/dev/null 2>&1; then
              echo "::warning::Package manager '$pkg_manager' found in image"
            fi
          done
      
      # Push secure image if all checks pass
      - name: Push secure image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5.3.0
        with:
          context: .
          file: ./${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # è»½é‡ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆPRç”¨ï¼‰
  quick-scan:
    name: Quick Security Scan (PR)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.1
      
      - name: Build image for quick scan
        run: |
          docker build -t temp-scan-image .
      
      - name: Quick vulnerability scan with Trivy
        uses: aquasecurity/trivy-action@0.18.0
        with:
          image-ref: 'temp-scan-image'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'  # é‡å¤§ãªè„†å¼±æ€§ã§PRå¤±æ•—
      
      - name: Basic security check
        run: |
          echo "ğŸ” Quick Security Check"
          echo "======================"
          
          # DockerfileåŸºæœ¬ãƒã‚§ãƒƒã‚¯
          if grep -q "FROM.*:latest" Dockerfile; then
            echo "::error::Using 'latest' tag in base image"
            exit 1
          fi
          
          if ! grep -q "USER " Dockerfile; then
            echo "::warning::No USER instruction found - may run as root"
          fi
          
          echo "âœ… Quick security check completed"

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [dockerfile-analysis, build-and-scan]
    if: always()
    
    permissions:
      contents: read
      actions: read
    
    steps:
      - name: Download scan artifacts
        uses: actions/download-artifact@v4.1.4
        continue-on-error: true
        with:
          path: ./scan-results
      
      - name: Generate security summary
        run: |
          echo "# ğŸ›¡ï¸ Docker Security Scan Report" > security-report.md
          echo "" >> security-report.md
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-report.md
          echo "Repository: ${{ github.repository }}" >> security-report.md
          echo "Commit: ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md
          
          echo "## Scan Results" >> security-report.md
          echo "- Dockerfile Analysis: ${{ needs.dockerfile-analysis.result }}" >> security-report.md
          echo "- Build and Scan: ${{ needs.build-and-scan.result }}" >> security-report.md
          echo "" >> security-report.md
          
          echo "## Security Tools Used" >> security-report.md
          echo "- ğŸ” Hadolint: Dockerfile linting" >> security-report.md
          echo "- ğŸ›¡ï¸ Trivy: Vulnerability scanning" >> security-report.md
          echo "- ğŸ Snyk: Container security" >> security-report.md
          echo "- ğŸš€ Docker Scout: CVE detection" >> security-report.md
          echo "- âœ… Checkov: Infrastructure security" >> security-report.md
          echo "" >> security-report.md
          
          echo "## Recommendations" >> security-report.md
          echo "- Use specific version tags instead of 'latest'" >> security-report.md
          echo "- Run containers as non-root user" >> security-report.md
          echo "- Use distroless or minimal base images" >> security-report.md
          echo "- Regularly update base images" >> security-report.md
          echo "- Remove unnecessary packages and tools" >> security-report.md
          echo "" >> security-report.md
          
          cat security-report.md
      
      - name: Upload security report
        uses: actions/upload-artifact@v4.3.1
        with:
          name: security-report
          path: security-report.md
          retention-days: 30
      
      - name: Comment PR with security summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7.0.1
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('security-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ”’ Docker Security Scan Results\n\n${report}`
            });

  # è„†å¼±æ€§ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ
  vulnerability-monitoring:
    name: Vulnerability Monitoring
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'schedule'
    
    steps:
      - name: Check for new vulnerabilities
        run: |
          echo "ğŸ” Checking for new vulnerabilities in published images"
          # æœ¬ç•ªã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ç¶™ç¶šç›£è¦–
          # ã“ã®éƒ¨åˆ†ã¯å®Ÿéš›ã®ç’°å¢ƒã«åˆã‚ã›ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
          
      - name: Alert on critical vulnerabilities
        if: failure()
        uses: 8398a7/action-slack@v3.16.2
        with:
          status: 'failure'
          channel: '#security-alerts'
          text: |
            ğŸš¨ Critical vulnerabilities detected in Docker images
            Repository: ${{ github.repository }}
            Please check and update affected images immediately.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}