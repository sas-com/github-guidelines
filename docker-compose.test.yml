# Docker Compose for PR Testing
# ã‚¨ã‚¹ãƒ»ã‚¨ãƒ¼ãƒ»ã‚¨ã‚¹æ ªå¼ä¼šç¤¾ - çµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒ

version: '3.8'

services:
  # =====================================
  # Primary Test Runner
  # =====================================
  test-runner:
    build:
      context: .
      dockerfile: docker/test/Dockerfile
      target: ci
    container_name: sas-test-runner
    volumes:
      - .:/app:ro
      - test-results:/app/test-results
      - security-reports:/app/security-reports
      - node-modules-cache:/app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
      - DATABASE_URL=postgresql://testuser:testpass@postgres:5432/testdb
      - REDIS_URL=redis://redis:6379/1
      - ELASTICSEARCH_URL=http://elasticsearch:9200
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - test-network
    command: ["ci-pipeline.sh"]
    mem_limit: 2g
    cpus: 2.0

  # =====================================
  # Security Scanner (Parallel)
  # =====================================
  security-scanner:
    build:
      context: .
      dockerfile: docker/test/Dockerfile
      target: security-scanner
    container_name: sas-security-scanner
    volumes:
      - .:/app:ro
      - security-reports:/app/security-reports
    environment:
      - SEMGREP_APP_TOKEN=${SEMGREP_APP_TOKEN}
      - SNYK_TOKEN=${SNYK_TOKEN}
    networks:
      - test-network
    command: ["run-security-scan.sh"]
    mem_limit: 1g
    cpus: 1.0

  # =====================================
  # Performance Tester
  # =====================================
  performance-tester:
    build:
      context: .
      dockerfile: docker/test/Dockerfile
      target: test-runner
    container_name: sas-performance-tester
    volumes:
      - .:/app:ro
      - test-results:/app/test-results
    environment:
      - NODE_ENV=production
      - LIGHTHOUSE_NO_SANDBOX=true
    ports:
      - "3000:3000"
    networks:
      - test-network
    profiles:
      - performance
    command: >
      sh -c "
        echo 'âš¡ Starting Performance Tests...'
        npm run build
        npm start &
        sleep 30
        
        # Lighthouse Tests
        lhci autorun --outputDir=test-results/performance/lighthouse || echo 'Lighthouse completed with warnings'
        
        # K6 Load Tests
        if [ -f tests/performance/load-test.js ]; then
          k6 run tests/performance/load-test.js --out json=test-results/performance/k6-results.json
        fi
        
        # Web Vitals Tests
        node tests/performance/web-vitals.js || echo 'Web Vitals test completed'
        
        echo 'âœ… Performance Tests Completed'
        tail -f /dev/null
      "
    mem_limit: 1.5g
    cpus: 1.5

  # =====================================
  # Database Services
  # =====================================
  postgres:
    image: postgres:15-alpine
    container_name: sas-test-postgres
    environment:
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpass
      POSTGRES_DB: testdb
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./tests/fixtures/sql:/docker-entrypoint-initdb.d:ro
    ports:
      - "5432:5432"
    networks:
      - test-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U testuser -d testdb"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s
    mem_limit: 512m

  redis:
    image: redis:7-alpine
    container_name: sas-test-redis
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    mem_limit: 128m

  # =====================================
  # Optional Services for Advanced Testing
  # =====================================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: sas-test-elasticsearch
    environment:
      - node.name=test-node
      - cluster.name=test-cluster
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms256m -Xmx256m"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - test-network
    profiles:
      - advanced
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
    mem_limit: 512m

  mongodb:
    image: mongo:7
    container_name: sas-test-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: testuser
      MONGO_INITDB_ROOT_PASSWORD: testpass
      MONGO_INITDB_DATABASE: testdb
    volumes:
      - mongodb-data:/data/db
    ports:
      - "27017:27017"
    networks:
      - test-network
    profiles:
      - advanced
    healthcheck:
      test: ["CMD", "mongo", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 10s
      retries: 5
    mem_limit: 256m

  # =====================================
  # Monitoring & Reporting
  # =====================================
  test-reporter:
    image: node:20-alpine
    container_name: sas-test-reporter
    volumes:
      - test-results:/app/test-results:ro
      - security-reports:/app/security-reports:ro
      - ./scripts:/app/scripts:ro
    working_dir: /app
    networks:
      - test-network
    profiles:
      - reporting
    command: >
      sh -c "
        echo 'ðŸ“Š Generating Comprehensive Test Report...'
        
        # Install report generation tools
        npm install -g junit-report-merger html-reporter
        
        # Merge JUnit reports
        mkdir -p reports
        junit-report-merger test-results/*/*.xml reports/merged-results.xml || echo 'JUnit merge completed'
        
        # Generate HTML report
        node scripts/generate-test-report.js || echo 'Report generation completed'
        
        echo 'âœ… Test reports generated in reports/ directory'
        tail -f /dev/null
      "

  # =====================================
  # SonarQube (Optional for full analysis)
  # =====================================
  sonarqube:
    image: sonarqube:10.2-community
    container_name: sas-sonarqube
    environment:
      SONAR_ES_BOOTSTRAP_CHECKS_DISABLE: true
    volumes:
      - sonarqube-data:/opt/sonarqube/data
      - sonarqube-extensions:/opt/sonarqube/extensions
      - sonarqube-logs:/opt/sonarqube/logs
    ports:
      - "9000:9000"
    networks:
      - test-network
    profiles:
      - sonar
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9000/api/system/status | grep -q UP || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    mem_limit: 2g

# =====================================
# Network Configuration
# =====================================
networks:
  test-network:
    driver: bridge
    name: sas-test-network

# =====================================
# Volume Configuration
# =====================================
volumes:
  postgres-data:
    name: sas-test-postgres-data
  redis-data:
    name: sas-test-redis-data
  elasticsearch-data:
    name: sas-test-elasticsearch-data
  mongodb-data:
    name: sas-test-mongodb-data
  sonarqube-data:
    name: sas-sonarqube-data
  sonarqube-extensions:
    name: sas-sonarqube-extensions
  sonarqube-logs:
    name: sas-sonarqube-logs
  test-results:
    name: sas-test-results
  security-reports:
    name: sas-security-reports
  node-modules-cache:
    name: sas-node-modules-cache