# Monitoring and Metrics Configuration
# エス・エー・エス株式会社 - GitHub運用ガイドライン

# Global Monitoring Configuration
global:
  # Basic settings
  monitoring_enabled: true
  retention_policy: 90d  # データ保持期間
  scrape_interval: 30s   # メトリクス取得間隔
  evaluation_interval: 30s  # アラート評価間隔
  
  # Time zone
  timezone: "Asia/Tokyo"
  
  # Contact information
  contact:
    team: "SAS Github管理チーム"
    email: "github@sas-com.com"
    slack_channel: "#github-alerts"
    teams_webhook: "https://outlook.office.com/webhook/xxx"

# Environment-specific Configuration
environments:
  development:
    monitoring_level: basic
    alert_severity: warning
    retention_days: 7
    
    # Metrics collection intervals
    metrics_interval: 60s
    log_level: debug
    
    # Alert thresholds (relaxed for development)
    thresholds:
      cpu_usage: 80%
      memory_usage: 85%
      disk_usage: 90%
      response_time: 5000ms
      error_rate: 10%
      availability: 90%
    
    # Notification settings
    notifications:
      enabled: true
      channels: [teams]
      quiet_hours: true
      quiet_hours_start: "22:00"
      quiet_hours_end: "08:00"

  staging:
    monitoring_level: intermediate
    alert_severity: warning
    retention_days: 30
    
    # Enhanced monitoring
    metrics_interval: 30s
    log_level: info
    distributed_tracing: true
    
    # Alert thresholds (moderate)
    thresholds:
      cpu_usage: 70%
      memory_usage: 75%
      disk_usage: 80%
      response_time: 1500ms
      error_rate: 2%
      availability: 95%
      
      # Database specific
      db_connections: 80
      db_response_time: 500ms
      
      # Cache specific
      cache_hit_ratio: 80%
      redis_memory: 75%
    
    # SLA monitoring
    sla:
      availability_target: 95.0
      response_time_p95: 1000ms
      error_rate_max: 1.0
    
    # Notifications
    notifications:
      enabled: true
      channels: [teams, email]
      escalation: true
      escalation_delay: 15m

  production:
    monitoring_level: enterprise
    alert_severity: critical
    retention_days: 90
    
    # Comprehensive monitoring
    metrics_interval: 15s
    log_level: warn
    distributed_tracing: true
    real_time_monitoring: true
    
    # Strict alert thresholds
    thresholds:
      cpu_usage: 60%
      memory_usage: 65%
      disk_usage: 75%
      response_time: 500ms
      error_rate: 0.5%
      availability: 99.5%
      
      # Database thresholds
      db_connections: 70
      db_response_time: 200ms
      db_deadlocks: 1
      
      # Cache thresholds
      cache_hit_ratio: 90%
      redis_memory: 70%
      
      # Business metrics
      conversion_rate_drop: -5%
      revenue_impact: -2%
      user_satisfaction: 95%
    
    # Strict SLA monitoring
    sla:
      availability_target: 99.9
      response_time_p95: 200ms
      response_time_p99: 500ms
      error_rate_max: 0.1
      mttr: 5m  # Mean Time To Recovery
      mttd: 2m  # Mean Time To Detection
    
    # Comprehensive notifications
    notifications:
      enabled: true
      channels: [teams, email, sms, pagerduty]
      immediate: true
      escalation: true
      escalation_levels:
        - delay: 5m
          contacts: [oncall_engineer]
        - delay: 15m
          contacts: [team_lead, devops_lead]
        - delay: 30m
          contacts: [engineering_manager, cto]

# Deployment Metrics Configuration
deployment_metrics:
  # DORA (DevOps Research and Assessment) Metrics
  dora_metrics:
    enabled: true
    
    # Deployment Frequency
    deployment_frequency:
      target:
        development: daily
        staging: weekly
        production: monthly
    
    # Lead Time for Changes
    lead_time_for_changes:
      target: 2h  # commit to production
      measurement_points:
        - commit_time
        - pr_creation
        - pr_merge
        - deployment_start
        - deployment_complete
    
    # Change Failure Rate
    change_failure_rate:
      target: 5%
      calculation: failed_deployments / total_deployments
      failure_criteria:
        - deployment_rollback
        - critical_bugs_within_24h
        - service_degradation
    
    # Time to Restore Service
    time_to_restore_service:
      target: 5m
      measurement:
        start: incident_detection
        end: service_restored

  # Deployment-specific Metrics
  deployment_specific:
    # Build metrics
    build_metrics:
      - build_duration
      - build_success_rate
      - build_failure_reasons
      - build_queue_time
      - artifact_size
    
    # Test metrics
    test_metrics:
      - test_execution_time
      - test_success_rate
      - test_coverage
      - test_flakiness_rate
      - test_failure_categories
    
    # Security metrics
    security_metrics:
      - vulnerability_scan_duration
      - vulnerabilities_found
      - vulnerabilities_fixed
      - security_gate_pass_rate
      - secret_detection_alerts

# Application Performance Monitoring (APM)
apm_config:
  # APM providers configuration
  providers:
    newrelic:
      enabled: false
      license_key: "${NEW_RELIC_LICENSE_KEY}"
    
    datadog:
      enabled: false
      api_key: "${DATADOG_API_KEY}"
    
    elastic_apm:
      enabled: true
      server_url: "${ELASTIC_APM_SERVER_URL}"
      secret_token: "${ELASTIC_APM_SECRET_TOKEN}"
  
  # Monitoring configuration
  monitoring:
    # Transaction tracing
    transaction_tracing:
      enabled: true
      slow_transaction_threshold: 1000ms
      
    # Database monitoring
    database_monitoring:
      enabled: true
      slow_query_threshold: 500ms
      
    # External service monitoring
    external_service_monitoring:
      enabled: true
      timeout_threshold: 3000ms
      
    # Error tracking
    error_tracking:
      enabled: true
      ignore_errors:
        - "401 Unauthorized"
        - "404 Not Found"

# Infrastructure Monitoring
infrastructure_monitoring:
  # System metrics
  system_metrics:
    - cpu_usage
    - memory_usage
    - disk_usage
    - disk_io
    - network_io
    - load_average
    - process_count
    - file_descriptors
  
  # Application metrics
  application_metrics:
    # HTTP metrics
    http_metrics:
      - request_rate
      - response_time
      - status_code_distribution
      - concurrent_connections
    
    # Database metrics
    database_metrics:
      - connection_count
      - query_rate
      - slow_queries
      - deadlocks
      - buffer_cache_hit_ratio
    
    # Cache metrics
    cache_metrics:
      - hit_ratio
      - miss_ratio
      - eviction_rate
      - memory_usage
      - key_count
  
  # Custom business metrics
  business_metrics:
    - user_registrations
    - login_success_rate
    - payment_transactions
    - api_usage_by_endpoint
    - feature_usage_statistics

# Log Management Configuration
log_management:
  # Log aggregation
  aggregation:
    enabled: true
    retention:
      development: 7d
      staging: 30d
      production: 365d
    
    # Log levels
    log_levels:
      development: debug
      staging: info
      production: warn
  
  # Structured logging
  structured_logging:
    enabled: true
    format: json
    fields:
      - timestamp
      - level
      - service
      - version
      - trace_id
      - user_id
      - request_id
      - environment
  
  # Log shipping
  log_shipping:
    elasticsearch:
      enabled: true
      hosts: ["${ELASTICSEARCH_HOST}"]
      index_pattern: "logs-${ENVIRONMENT}-%{+YYYY.MM.dd}"
    
    fluentd:
      enabled: false
      host: "${FLUENTD_HOST}"
      port: 24224

# Alert Rules Configuration
alert_rules:
  # System alerts
  system_alerts:
    - name: high_cpu_usage
      condition: cpu_usage > 70%
      duration: 5m
      severity: warning
      description: "CPU usage is above 70%"
      
    - name: critical_cpu_usage
      condition: cpu_usage > 90%
      duration: 2m
      severity: critical
      description: "CPU usage is critically high"
      
    - name: high_memory_usage
      condition: memory_usage > 80%
      duration: 5m
      severity: warning
      description: "Memory usage is above 80%"
      
    - name: disk_space_low
      condition: disk_usage > 85%
      duration: 1m
      severity: critical
      description: "Disk space is running low"
  
  # Application alerts
  application_alerts:
    - name: high_response_time
      condition: response_time_p95 > 1000ms
      duration: 3m
      severity: warning
      description: "95th percentile response time is high"
      
    - name: high_error_rate
      condition: error_rate > 5%
      duration: 2m
      severity: critical
      description: "Error rate is above threshold"
      
    - name: service_availability_low
      condition: availability < 99%
      duration: 1m
      severity: critical
      description: "Service availability is below SLA"
  
  # Business alerts
  business_alerts:
    - name: conversion_rate_drop
      condition: conversion_rate < baseline * 0.9
      duration: 10m
      severity: warning
      description: "Conversion rate dropped significantly"
      
    - name: payment_failure_spike
      condition: payment_failure_rate > 2%
      duration: 5m
      severity: critical
      description: "Payment failure rate is unusually high"

# Dashboard Configuration
dashboards:
  # System dashboard
  system_dashboard:
    name: "System Overview"
    panels:
      - cpu_usage_panel
      - memory_usage_panel
      - disk_usage_panel
      - network_io_panel
      - process_panel
  
  # Application dashboard
  application_dashboard:
    name: "Application Performance"
    panels:
      - response_time_panel
      - request_rate_panel
      - error_rate_panel
      - database_performance_panel
      - cache_performance_panel
  
  # Business dashboard
  business_dashboard:
    name: "Business Metrics"
    panels:
      - user_activity_panel
      - conversion_funnel_panel
      - revenue_panel
      - feature_adoption_panel
  
  # Deployment dashboard
  deployment_dashboard:
    name: "Deployment Metrics"
    panels:
      - deployment_frequency_panel
      - lead_time_panel
      - change_failure_rate_panel
      - recovery_time_panel

# Synthetic Monitoring
synthetic_monitoring:
  enabled: true
  
  # Health checks
  health_checks:
    - name: main_endpoint
      url: "https://sas-com.example.com/health"
      interval: 30s
      timeout: 10s
      expected_status: 200
      
    - name: api_endpoint
      url: "https://sas-com.example.com/api/v1/status"
      interval: 60s
      timeout: 15s
      expected_status: 200
      headers:
        Authorization: "Bearer ${HEALTH_CHECK_TOKEN}"
  
  # User journey monitoring
  user_journeys:
    - name: user_registration
      steps:
        - visit_homepage
        - click_signup
        - fill_form
        - submit_registration
        - verify_confirmation
      interval: 15m
      timeout: 60s
      
    - name: user_login
      steps:
        - visit_login_page
        - enter_credentials
        - submit_login
        - verify_dashboard
      interval: 5m
      timeout: 30s

# Security Monitoring
security_monitoring:
  enabled: true
  
  # Security events
  security_events:
    - failed_login_attempts
    - privilege_escalation_attempts
    - data_access_anomalies
    - malware_detection
    - suspicious_network_activity
  
  # Threat detection
  threat_detection:
    enabled: true
    machine_learning: true
    baseline_learning_period: 7d
    
    # Detection rules
    detection_rules:
      - name: brute_force_attack
        condition: failed_logins > 10 in 5m
        severity: high
        
      - name: data_exfiltration
        condition: data_transfer > baseline * 3
        severity: critical
        
      - name: privilege_escalation
        condition: admin_access_outside_business_hours
        severity: high

# Performance Monitoring
performance_monitoring:
  # Real User Monitoring (RUM)
  rum:
    enabled: true
    sample_rate: 10%  # Monitor 10% of real users
    
    metrics:
      - page_load_time
      - first_contentful_paint
      - largest_contentful_paint
      - cumulative_layout_shift
      - first_input_delay
      - time_to_interactive
  
  # Core Web Vitals
  core_web_vitals:
    enabled: true
    thresholds:
      largest_contentful_paint: 2.5s
      first_input_delay: 100ms
      cumulative_layout_shift: 0.1

# Cost Monitoring
cost_monitoring:
  enabled: true
  
  # Budget alerts
  budget_alerts:
    - name: monthly_infrastructure_cost
      threshold: 10000  # USD
      period: monthly
      severity: warning
      
    - name: daily_cost_spike
      threshold: 500  # USD
      period: daily
      severity: critical
  
  # Resource optimization
  resource_optimization:
    enabled: true
    recommendations: true
    auto_scaling: true

# Compliance Monitoring
compliance_monitoring:
  enabled: true
  
  # Audit logging
  audit_logging:
    enabled: true
    events:
      - user_access
      - data_modifications
      - privilege_changes
      - configuration_changes
      - deployment_events
  
  # Compliance frameworks
  frameworks:
    gdpr:
      enabled: true
      data_retention_monitoring: true
      consent_tracking: true
      
    pci_dss:
      enabled: true
      cardholder_data_monitoring: true
      access_control_monitoring: true
      
    sox:
      enabled: true
      financial_controls_monitoring: true
      change_management_monitoring: true

# Integration Configuration
integrations:
  # Slack integration
  slack:
    enabled: true
    webhook_url: "${SLACK_WEBHOOK_URL}"
    channels:
      - "#alerts"
      - "#deployments"
      - "#infrastructure"
  
  # Microsoft Teams integration
  teams:
    enabled: true
    webhook_url: "${TEAMS_WEBHOOK_URL}"
  
  # PagerDuty integration
  pagerduty:
    enabled: true
    integration_key: "${PAGERDUTY_INTEGRATION_KEY}"
    escalation_policy: "SAS-Engineering-Escalation"
  
  # Jira integration
  jira:
    enabled: true
    server_url: "${JIRA_SERVER_URL}"
    username: "${JIRA_USERNAME}"
    api_token: "${JIRA_API_TOKEN}"
    project_key: "OPS"
  
  # Email integration
  email:
    enabled: true
    smtp_server: "${SMTP_SERVER}"
    smtp_port: 587
    username: "${SMTP_USERNAME}"
    password: "${SMTP_PASSWORD}"
    from_address: "alerts@sas-com.example.com"

# Maintenance Windows
maintenance_windows:
  # Scheduled maintenance
  scheduled_maintenance:
    - name: weekly_maintenance
      schedule: "0 2 * * SUN"  # Every Sunday at 2 AM
      duration: 2h
      suppress_alerts: true
      
    - name: monthly_maintenance
      schedule: "0 1 1 * *"    # First day of month at 1 AM
      duration: 4h
      suppress_alerts: true
  
  # Emergency maintenance
  emergency_maintenance:
    duration: 1h
    auto_suppress_alerts: true
    notification_required: true