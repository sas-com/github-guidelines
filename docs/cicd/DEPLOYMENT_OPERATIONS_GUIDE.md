# デプロイ運用手順書

**エス・エー・エス株式会社**  
*GitHub運用ガイドライン - デプロイ運用手順書*

## 目次

- [概要](#概要)
- [日常運用手順](#日常運用手順)
- [環境別デプロイ手順](#環境別デプロイ手順)
- [緊急時対応手順](#緊急時対応手順)
- [監視・メンテナンス](#監視メンテナンス)
- [トラブルシューティング](#トラブルシューティング)
- [よくある質問](#よくある質問)

## 概要

本ドキュメントは、エス・エー・エス株式会社のGitHub環境におけるデプロイ運用の手順書です。開発者、運用担当者、管理者それぞれの役割に応じた詳細な手順を提供します。

### 対象読者

- **開発者**: 機能開発とデプロイ実行
- **開発リーダー**: 承認とコードレビュー
- **運用担当者**: 監視とトラブル対応
- **マネージャー**: 承認と意思決定

### 環境構成

| 環境 | 目的 | 承認要件 | 頻度 |
|------|------|----------|------|
| Development | 機能開発・テスト | 自動 | 随時 |
| Staging | 統合テスト・UAT | 開発リーダー1名 | 日次～週次 |
| Production | 本番サービス | リーダー+マネージャー | 週次～月次 |

## 日常運用手順

### 開発者の日常業務

#### 1. 機能開発とテスト

```bash
# 1. 最新のdevブランチを取得
git checkout dev
git pull origin dev

# 2. 機能ブランチを作成
git checkout -b feature/new-functionality

# 3. 機能開発とテスト
# ... 開発作業 ...

# 4. コミットとプッシュ
git add .
git commit -m "feat: 新機能を実装"
git push origin feature/new-functionality
```

#### 2. Development環境へのデプロイ

**自動デプロイ**: devブランチへのマージで自動実行

```bash
# 1. devブランチにマージ
git checkout dev
git merge feature/new-functionality
git push origin dev

# 2. GitHub Actionsの実行を確認
# https://github.com/sas-com/github-guidelines/actions

# 3. デプロイ結果の確認
# https://dev.sas-com.example.com/health
```

**手動デプロイ**: 必要時のみ

1. GitHub UI → Actions → "Deploy to Development Environment"
2. "Run workflow" → ブランチ選択 → "Run workflow"

#### 3. 品質チェック

```bash
# ローカル品質チェック
npm run lint
npm run test
npm run security:scan

# ビルド確認
npm run build:dev
```

### 開発リーダーの業務

#### 1. コードレビュー

**プルリクエストレビュー**

1. 機能要件の充足確認
2. コード品質の確認
3. セキュリティ観点での確認
4. パフォーマンス影響の確認
5. テストカバレッジの確認

**レビューチェックリスト**

- [ ] ビジネス要件を満たしているか
- [ ] コードスタイルが統一されているか
- [ ] セキュリティ上の問題がないか
- [ ] パフォーマンスに悪影響がないか
- [ ] テストが適切に書かれているか
- [ ] ドキュメントが更新されているか

#### 2. Staging環境デプロイの承認

**承認手順**

1. GitHub UI → Environments → Staging
2. Pending deployments の確認
3. デプロイ内容の最終確認
4. "Review deployments" → "Approve and deploy"

**承認判断基準**

- Development環境での動作確認完了
- 必要なテストの実行完了
- セキュリティスキャンの通過
- 影響範囲の把握

### マネージャーの業務

#### 1. Production環境デプロイの承認

**承認手順**

1. デプロイ要請の内容確認
2. ビジネス影響度の評価
3. リスク評価の実施
4. 承認可否の決定

**承認判断基準**

- ビジネス価値の確認
- リスク評価の妥当性
- 緊急度レベルの適切性
- 運用体制の準備状況

## 環境別デプロイ手順

### Development環境デプロイ

**対象者**: 開発者
**頻度**: 随時（1日複数回）
**承認**: 不要

#### 自動デプロイ手順

```bash
# 1. devブランチに機能をマージ
git checkout dev
git merge feature/your-feature
git push origin dev

# 2. GitHub Actionsの実行確認
# - Build成功
# - テスト通過
# - セキュリティスキャン通過
# - デプロイ成功

# 3. 動作確認
curl https://dev.sas-com.example.com/health
```

#### 手動デプロイ手順

1. **GitHub UI操作**
   - Actions → "Deploy to Development Environment"
   - "Run workflow" → ブランチ選択
   - "Run workflow" ボタンクリック

2. **実行監視**
   - ワークフロー実行ログの確認
   - エラー発生時は即座に対応

3. **動作確認**
   - ヘルスチェックエンドポイント確認
   - 主要機能の動作確認

### Staging環境デプロイ

**対象者**: 開発者（実行）、開発リーダー（承認）
**頻度**: 日次～週次
**承認**: 開発リーダー1名

#### デプロイ手順

1. **事前準備**
   ```bash
   # Staging環境の現在状況確認
   curl https://staging.sas-com.example.com/health
   
   # デプロイ対象の変更内容確認
   git log --oneline staging..dev
   ```

2. **デプロイ実行**
   - GitHub UI → Actions → "Deploy to Staging Environment"
   - "Run workflow" → dev選択 → "Run workflow"

3. **承認待ち**
   - 開発リーダーに承認依頼通知
   - 必要に応じて口頭での説明

4. **承認後の確認**
   ```bash
   # ヘルスチェック
   curl https://staging.sas-com.example.com/health
   
   # 統合テスト実行
   npm run test:integration:staging
   
   # E2Eテスト実行
   npm run test:e2e:staging
   ```

#### 承認者（開発リーダー）の手順

1. **デプロイ内容確認**
   - 変更内容の詳細レビュー
   - テスト結果の確認
   - セキュリティスキャン結果の確認

2. **影響度評価**
   - 機能への影響範囲
   - パフォーマンスへの影響
   - セキュリティリスク

3. **承認実行**
   - GitHub UI → Environments → Staging
   - "Review deployments" → 内容確認 → "Approve and deploy"

### Production環境デプロイ

**対象者**: 開発者（実行）、リーダー+マネージャー（承認）
**頻度**: 週次～月次
**承認**: 2名（開発リーダー + マネージャー）

#### デプロイ手順

1. **事前準備**
   ```bash
   # 現在の本番環境状況確認
   curl https://sas-com.example.com/health
   
   # デプロイ対象の詳細確認
   git log --oneline main..staging
   
   # リリースノート作成
   # 変更内容、影響範囲、テスト結果を記載
   ```

2. **メンテナンス通知**
   - ユーザーへの事前通知（24時間前推奨）
   - 関係者への作業開始通知
   - 監視チームへの連絡

3. **デプロイ実行**
   - GitHub UI → Actions → "Deploy to Production Environment"
   - Deployment type: "standard"
   - Emergency level: "L4"
   - "Run workflow"

4. **承認プロセス**
   - 開発リーダー承認
   - マネージャー承認
   - 5分間の最終確認タイマー

5. **デプロイ監視**
   - Blue-Green切替の監視
   - カナリアデプロイメント確認（10%トラフィック）
   - パフォーマンスメトリクス監視

6. **本番稼働確認**
   ```bash
   # クリティカルパス確認
   curl https://sas-com.example.com/health
   curl https://sas-com.example.com/api/v1/status
   
   # 主要機能の動作確認
   # - ユーザー認証
   # - 主要API
   # - 決済機能（該当時）
   ```

## 緊急時対応手順

### 緊急度レベル分類

| レベル | 定義 | 対応時間 | エスカレーション |
|--------|------|----------|------------------|
| L1 | Critical - サービス完全停止 | 1時間以内 | 即座 |
| L2 | High - 主要機能停止 | 4時間以内 | 15分以内 |
| L3 | Medium - 部分機能停止 | 1営業日以内 | 1時間以内 |
| L4 | Low - 軽微な問題 | 3営業日以内 | 4時間以内 |

### 緊急ロールバック手順

#### L1（Critical）緊急時

```bash
# 1. 即座にロールバック実行
# GitHub UI → Actions → "Emergency Rollback"
# Target Environment: production
# Emergency Level: L1
# Rollback Target: [前回安定版]
# Reason: [具体的な理由]

# 2. 関係者への即座通知
# - SAS Github管理チーム (github@sas-com.com)
# - 経営陣
# - カスタマーサポート

# 3. ロールバック完了確認
curl https://sas-com.example.com/health
```

#### L2（High）緊急時

```bash
# 1. 状況の詳細調査（5分間）
# - ログ確認
# - メトリクス確認
# - 影響範囲特定

# 2. ロールバック実行
# GitHub UI → Actions → "Emergency Rollback"
# Target Environment: production
# Emergency Level: L2
# Rollback Target: [前回安定版]

# 3. 段階的な通知実施
```

### インシデント対応フロー

#### 1. 検知・初動対応（0-5分）

```bash
# アラート検知時の初動
# 1. アラート内容の確認
# 2. 影響範囲の特定
# 3. 緊急度レベルの判定
# 4. 初動対応チームの召集
```

#### 2. 詳細調査・対応方針決定（5-15分）

```bash
# 調査項目
# - システムログ確認
# - パフォーマンスメトリクス確認
# - エラー率・レスポンス時間確認
# - 外部システム依存関係確認

# 対応方針の選択
# A. ロールバック実行
# B. 緊急パッチ適用
# C. 部分機能停止
# D. 監視強化継続
```

#### 3. 対応実行・監視（15分-解決まで）

```bash
# ロールバック選択時
# 1. Emergency Rollback workflow実行
# 2. ロールバック進行状況監視
# 3. サービス復旧確認
# 4. 継続監視開始

# パッチ適用選択時
# 1. Hotfix branch作成
# 2. 緊急パッチ実装
# 3. 最小限テスト実行
# 4. 緊急デプロイ実行
```

### 緊急連絡体制

#### 連絡先一覧

| 役割 | 連絡先 | 対応時間 |
|------|--------|----------|
| SAS Github管理チーム | github@sas-com.com | 24時間 |
| 開発リーダー | [内部連絡先] | 営業時間 |
| インフラチーム | [内部連絡先] | 24時間 |
| マネージャー | [内部連絡先] | 営業時間 |

#### エスカレーション手順

```
L1 Critical → 即座にすべての関係者に連絡
    ↓
L2 High → 15分以内に管理チーム + リーダーに連絡
    ↓
L3 Medium → 1時間以内に管理チーム + 担当者に連絡
    ↓
L4 Low → 4時間以内に担当者に連絡
```

## 監視・メンテナンス

### 日常監視項目

#### システムメトリクス

```bash
# 1. 基本メトリクス確認
# - CPU使用率: < 70%
# - メモリ使用率: < 75%
# - ディスク使用率: < 80%
# - ネットワーク帯域: 監視

# 2. アプリケーションメトリクス
# - レスポンス時間: P95 < 500ms
# - エラー率: < 0.5%
# - スループット: 基準値との比較
# - 可用性: > 99.9%

# 3. ビジネスメトリクス
# - ユーザー数: トレンド監視
# - 売上: 異常値検知
# - 変換率: 前日比較
```

#### ログ監視

```bash
# 重要ログパターン
grep -E "(ERROR|FATAL|CRITICAL)" /var/log/application.log
grep -E "Exception|SQLException" /var/log/application.log
grep -E "(404|500|502|503)" /var/log/nginx/access.log

# セキュリティ関連
grep -E "authentication.*failed" /var/log/auth.log
grep -E "privilege.*escalation" /var/log/security.log
```

### 定期メンテナンス

#### 週次メンテナンス（日曜日 2:00-4:00）

```bash
# 1. セキュリティパッチ適用確認
sudo apt list --upgradable | grep -i security

# 2. ログローテーション確認
sudo logrotate -d /etc/logrotate.conf

# 3. バックアップ状態確認
# バックアップジョブの実行状況確認

# 4. 証明書有効期限確認
openssl x509 -in /path/to/cert.pem -noout -dates

# 5. 不要ファイル削除
find /tmp -type f -mtime +7 -delete
```

#### 月次メンテナンス（第1日曜日）

```bash
# 1. パフォーマンス分析レポート作成
# - 月間パフォーマンストレンド
# - リソース使用量分析
# - 容量計画見直し

# 2. セキュリティ監査
# - 脆弱性スキャン実行
# - アクセス権限監査
# - セキュリティパッチ適用状況

# 3. 災害復旧テスト
# - バックアップからの復旧テスト
# - フェイルオーバーテスト
# - 緊急手順の見直し
```

## トラブルシューティング

### よくある問題と対処法

#### 1. デプロイ失敗

**症状**: GitHub Actionsでデプロイが失敗する

**原因調査**:
```bash
# GitHub Actionsログ確認
# 1. https://github.com/sas-com/github-guidelines/actions
# 2. 失敗したワークフロー選択
# 3. 失敗したjobとstepを特定

# 環境確認
curl https://[環境URL]/health
```

**一般的な対処法**:
- **依存関係エラー**: `npm ci` → `npm install` で解決
- **テスト失敗**: テストログ確認 → 問題修正 → 再実行
- **セキュリティスキャン失敗**: 脆弱性修正 → 再実行
- **タイムアウト**: リソース不足確認 → スケールアップ

#### 2. パフォーマンス劣化

**症状**: レスポンス時間が長い、エラー率が高い

**調査手順**:
```bash
# 1. リソース使用状況確認
top
htop
iostat

# 2. アプリケーションログ確認
tail -f /var/log/application.log | grep -E "(ERROR|WARN)"

# 3. データベース状況確認
# - スロークエリログ
# - コネクション数
# - インデックス使用状況

# 4. 外部依存サービス確認
curl -w "%{time_total}" https://external-api.example.com/status
```

**対処法**:
- **リソース不足**: スケールアップ実行
- **データベース問題**: クエリ最適化、インデックス追加
- **外部サービス問題**: タイムアウト設定調整、リトライ実装

#### 3. セキュリティアラート

**症状**: セキュリティ監視でアラートが発生

**初動対応**:
```bash
# 1. アラート内容の詳細確認
# - 攻撃タイプの特定
# - 影響範囲の調査
# - 攻撃元の特定

# 2. 緊急対応
# - 疑わしい接続の遮断
# - 該当アカウントの一時停止
# - ログの保全

# 3. セキュリティチームへの連絡
```

#### 4. データベース接続エラー

**症状**: アプリケーションからDBに接続できない

**調査手順**:
```bash
# 1. データベース状態確認
sudo systemctl status postgresql
sudo systemctl status mysql

# 2. 接続テスト
telnet db-server 5432
mysql -h db-server -u username -p

# 3. コネクションプール確認
# アプリケーションログでpool設定確認
```

**対処法**:
```bash
# 接続数上限に達している場合
# 1. 不要な接続の解放
# 2. コネクションプール設定見直し
# 3. データベースの最大接続数増加

# データベース停止している場合
sudo systemctl start postgresql
sudo systemctl start mysql
```

### 緊急時チェックリスト

#### サービス停止時の確認項目

- [ ] ヘルスチェックエンドポイントの応答
- [ ] アプリケーションプロセスの状態
- [ ] データベース接続状態
- [ ] 外部サービス依存関係
- [ ] ネットワーク接続状態
- [ ] リソース使用状況（CPU、メモリ、ディスク）
- [ ] ログファイルのエラー内容
- [ ] 最近のデプロイ履歴

#### パフォーマンス問題時の確認項目

- [ ] システムリソース使用率
- [ ] データベースパフォーマンス
- [ ] アプリケーションレスポンス時間
- [ ] 外部API呼び出し時間
- [ ] ネットワーク遅延
- [ ] キャッシュヒット率
- [ ] スロークエリの有無

## よくある質問

### Q1: デプロイが失敗した場合、どのように対応すべきですか？

**A1**: 以下の手順で対応してください：

1. **エラー内容の確認**: GitHub Actionsのログで詳細なエラーメッセージを確認
2. **影響範囲の特定**: 失敗した環境と影響を受ける機能を特定
3. **復旧方法の選択**:
   - 軽微な問題: 修正後に再デプロイ
   - 重大な問題: 前回安定版へのロールバック
4. **関係者への報告**: 必要に応じて管理チームへ報告

### Q2: 本番環境へのデプロイ承認が遅れている場合はどうしますか？

**A2**: 以下の対応を取ってください：

1. **承認者への直接連絡**: メールやチャットで状況を説明
2. **緊急度の再評価**: 本当に緊急度が高い場合はエスカレーション
3. **代替承認者の確認**: マネージャーが不在の場合の代替手順の確認
4. **延期の検討**: 急がない場合は適切なタイミングまで延期

### Q3: セキュリティスキャンで脆弱性が検出された場合は？

**A3**: 脆弱性の重要度に応じて対応：

**Critical/High**:
- 即座に修正対応
- パッチ適用またはライブラリ更新
- 再スキャンで修正確認

**Medium/Low**:
- 修正計画の策定
- 次回リリースで修正
- 暫定的な軽減策の実装

### Q4: ロールバック後に問題が解決しない場合は？

**A4**: 以下の段階的な対応：

1. **詳細調査**: ログとメトリクスの詳細分析
2. **外部要因確認**: ネットワーク、外部サービスの状況確認
3. **段階的復旧**: 部分的な機能復旧から開始
4. **専門家への相談**: 解決困難な場合は外部専門家へ相談

### Q5: 定期メンテナンス中に問題が発生した場合は？

**A5**: メンテナンス特有の対応：

1. **メンテナンス作業の一時停止**
2. **現在の状態の把握**: 作業途中の状況を詳細に記録
3. **安全な状態への復帰**: 可能な限り開始前の状態に戻す
4. **原因調査と対策**: 問題の根本原因を特定
5. **再実行計画**: 修正した手順で再度メンテナンス実行

---

## 関連ドキュメント

- [環境別デプロイ戦略](./ENVIRONMENT_DEPLOYMENT_STRATEGY.md)
- [緊急時対応マニュアル](./EMERGENCY_RESPONSE.md)
- [GitHub Actions運用ガイド](./GITHUB_ACTIONS_OPERATIONS.md)
- [セキュリティ・リスク管理](./SECURITY_RISK_MATRIX.md)
- [トラブルシューティング](./TROUBLESHOOTING.md)

---

**作成者**: エス・エー・エス株式会社 GitHub管理チーム  
**最終更新**: 2024年9月10日  
**バージョン**: 1.0.0