#!/bin/bash

# SAS Prepare Commit Message Hook
# Provides commit message templates and interactive assistance
# Helps developers write proper conventional commit messages

set -e

COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="$2"
SHA1="$3"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Skip if this is a merge, squash, or amend
if [[ "$COMMIT_SOURCE" == "merge" ]] || [[ "$COMMIT_SOURCE" == "squash" ]] || [[ "$COMMIT_SOURCE" == "commit" ]]; then
    exit 0
fi

# Skip if message already exists (amend, -m option, etc.)
if [[ -s "$COMMIT_MSG_FILE" ]] && [[ "$(cat "$COMMIT_MSG_FILE" | head -1)" != "" ]]; then
    exit 0
fi

# Function to display commit message template
show_template() {
    cat > "$COMMIT_MSG_FILE" << 'EOF'
# SAS コミットメッセージテンプレート
# 
# フォーマット: <type>[scope]: <description>
#
# Type (必須):
#   feat     - 新機能の追加
#   fix      - バグ修正
#   docs     - ドキュメント変更のみ
#   style    - フォーマット変更（動作に影響なし）
#   refactor - リファクタリング
#   test     - テストの追加・修正
#   chore    - ビルドプロセス・補助ツールの変更
#   security - セキュリティ関連の修正
#   perf     - パフォーマンス改善
#   build    - ビルドシステム変更
#   ci       - CI設定変更
#   revert   - コミットの取り消し
#   hotfix   - 緊急修正
#
# Scope (任意): auth, api, ui, db, docs など
#
# Description (必須):
#   - 72文字以内（日本語は50文字程度推奨）
#   - 命令形で記述（「追加する」ではなく「追加」）
#   - 小文字で開始、末尾のピリオド不要
#   - 日本語推奨
#
# 例:
#   feat(auth): OAuth2.0ログイン機能を追加
#   fix(api): ユーザー検索時の重複結果を修正
#   docs(readme): セットアップ手順を更新
#
# 詳細が必要な場合は、空行の後に本文を記述:
#
# Body (任意):
#   - 変更の理由や背景
#   - 影響範囲
#   - 注意事項
#
# Footer (任意):
#   - Breaking Change: BREAKING CHANGE: 説明
#   - Issue参照: Closes #123, Fixes #456
#   - 共著者: Co-authored-by: name <email>
#
# 詳細: COMMIT_CONVENTION_GUIDE.md を参照

EOF
}

# Function to get suggested type based on file changes
get_suggested_type() {
    local changes
    changes=$(git diff --cached --name-only 2>/dev/null || echo "")
    
    if [[ -z "$changes" ]]; then
        echo "chore"
        return
    fi
    
    # Check for documentation changes
    if echo "$changes" | grep -qE "\.(md|txt|rst|adoc)$"; then
        echo "docs"
        return
    fi
    
    # Check for test files
    if echo "$changes" | grep -qE "(test|spec|__tests__|\.test\.|\.spec\.)" -i; then
        echo "test"
        return
    fi
    
    # Check for config files
    if echo "$changes" | grep -qE "\.(json|yaml|yml|toml|ini|conf|config)$|Dockerfile|\.env|package\.json|pom\.xml"; then
        echo "chore"
        return
    fi
    
    # Check for CI/CD files
    if echo "$changes" | grep -qE "\.github|\.gitlab-ci|jenkins|azure-pipelines|buildspec"; then
        echo "ci"
        return
    fi
    
    # Check for build files
    if echo "$changes" | grep -qE "webpack|rollup|vite|gulp|grunt|Makefile|CMakeLists"; then
        echo "build"
        return
    fi
    
    # Check for style files
    if echo "$changes" | grep -qE "\.(css|scss|sass|less|styl)$"; then
        echo "style"
        return
    fi
    
    # Default to feat for new functionality
    echo "feat"
}

# Function to get suggested scope
get_suggested_scope() {
    local changes
    changes=$(git diff --cached --name-only 2>/dev/null || echo "")
    
    if [[ -z "$changes" ]]; then
        return
    fi
    
    # Extract common directory patterns
    local scope
    scope=$(echo "$changes" | sed 's|/.*||' | sort | uniq -c | sort -nr | head -1 | awk '{print $2}')
    
    # Map common directories to meaningful scopes
    case "$scope" in
        "src"|"lib"|"app") 
            local subscore
            subscope=$(echo "$changes" | grep "^$scope/" | sed "s|^$scope/||" | sed 's|/.*||' | sort | uniq -c | sort -nr | head -1 | awk '{print $2}')
            if [[ -n "$subscope" ]] && [[ "$subscope" != "" ]]; then
                echo "$subscope"
            fi
            ;;
        "docs"|"documentation") echo "docs" ;;
        "test"|"tests"|"spec") echo "test" ;;
        "config"|"configs") echo "config" ;;
        ".github"|".gitlab") echo "ci" ;;
        *) echo "$scope" ;;
    esac
}

# Generate smart template
generate_smart_template() {
    local suggested_type
    local suggested_scope
    local changes_summary
    
    suggested_type=$(get_suggested_type)
    suggested_scope=$(get_suggested_scope)
    changes_summary=$(git diff --cached --stat 2>/dev/null | tail -1 || echo "")
    
    cat > "$COMMIT_MSG_FILE" << EOF
$suggested_type${suggested_scope:+($suggested_scope)}: 

# 変更内容: $changes_summary
#
# Type: $suggested_type (推奨)
# Scope: ${suggested_scope:-"なし"} ${suggested_scope:+(推奨)}
#
# このコミットの変更内容を簡潔に説明してください
# 例: OAuth2.0ログイン機能を追加
#     ユーザー検索APIのバグを修正
#     README.mdにセットアップ手順を追加
#
# より詳細な説明が必要な場合は、空行の後に記述:
# 
# - 変更の理由
# - 影響範囲
# - 注意事項
# - 関連するIssue番号 (Closes #123)

EOF
}

# Check if we should provide interactive assistance
if [[ -t 1 ]] && command -v git >/dev/null 2>&1; then
    # Interactive mode available
    echo -e "${BLUE}SAS コミットメッセージアシスタント${NC}"
    echo -e "${YELLOW}変更されたファイルに基づいてテンプレートを生成します...${NC}"
    
    generate_smart_template
    
    echo -e "${GREEN}✓ スマートテンプレートを生成しました${NC}"
    echo -e "${YELLOW}エディタでコミットメッセージを編集してください${NC}"
    echo -e "${YELLOW}テンプレートのコメント行は自動的に削除されます${NC}"
else
    # Non-interactive mode - provide basic template
    show_template
fi